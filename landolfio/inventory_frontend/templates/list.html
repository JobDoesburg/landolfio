{% extends "page-no-header.html" %}
{% load static i18n l10n dict_extras %}

{% block header %}
    <!-- Search Header -->
    <div class="row py-4">
        <div class="col">
            <form action="{% url 'inventory_frontend:list' %}" method="get" class="d-flex gap-3 align-items-center">
                <a href="{% url 'inventory_frontend:search' %}">
                    <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height: 48px;">
                </a>
                <div class="flex-grow-1 position-relative">
                    <input type="text" name="q" id="search-input" class="form-control"
                           placeholder="{% translate 'Search assets...' %}"
                           value="{{ request.GET.q|default:'' }}"
                           autocomplete="off">
                    <div id="autocomplete-suggestions" class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 400px; overflow-y: auto;"></div>
                    <button type="submit" class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2">
                        <i class="fas fa-search text-muted"></i>
                    </button>
                </div>
                <a href="{% url 'inventory_frontend:create' %}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>{% translate "New" %}
                </a>
                <a href="{% url 'admin:index' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-cog me-2"></i>{% translate "Admin" %}
                </a>
            </form>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                <!-- Filter Form -->
                <div class="collapse d-md-block flex-grow-1" id="filter-collapse">
                    <form method="get" id="filter-form" class="d-flex flex-wrap gap-2 justify-content-center justify-content-md-start">
                    <!-- Preserve search query -->
                    {% if request.GET.q %}
                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                    {% endif %}
                    
                    <!-- Preserve property filters -->
                    {% for property in all_properties %}
                        {% for value in property.current_values %}
                            <input type="hidden" name="{{ property.slug }}" value="{{ value }}">
                        {% endfor %}
                        {% if property.property_type == 'number' %}
                            {% if property.current_min %}
                                <input type="hidden" name="{{ property.slug }}_min" value="{{ property.current_min }}">
                            {% endif %}
                            {% if property.current_max %}
                                <input type="hidden" name="{{ property.slug }}_max" value="{{ property.current_max }}">
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    <!-- Category Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown" style="min-width: 150px;">
                            {% translate "Categories" %}
                            {% if current_filters.categories %}
                                <span class="badge bg-primary ms-1">{{ current_filters.categories|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 250px; max-height: 300px; overflow-y: auto;">
                            {% for category in categories %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="category" value="{{ category.id }}" 
                                           id="category-{{ category.id }}" 
                                           {% if category.id|stringformat:"s" in current_filters.categories %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label" for="category-{{ category.id }}">
                                        {{ category.name }} ({{ category.asset_count }})
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Location Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown" style="min-width: 150px;">
                            {% translate "Locations" %}
                            {% if current_filters.locations %}
                                <span class="badge bg-primary ms-1">{{ current_filters.locations|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 280px; max-height: 400px; overflow-y: auto;">
                            {% for location_group in location_groups %}
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input location-group-checkbox" type="checkbox" 
                                               id="location-group-{{ location_group.id }}" 
                                               data-group-id="{{ location_group.id }}"
                                               onchange="toggleLocationGroup({{ location_group.id }})">
                                        <label class="form-check-label fw-bold text-dark small" for="location-group-{{ location_group.id }}">
                                            {{ location_group.name }}
                                            {% if location_group.asset_count > 0 %}
                                                <span class="badge bg-primary text-white ms-1">{{ location_group.asset_count }}</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    <div class="border-bottom mb-2"></div>
                                    {% for location in location_group.location_set.all %}
                                        <div class="form-check ms-3">
                                            <input class="form-check-input location-checkbox" type="checkbox" name="location" value="{{ location.id }}" 
                                                   id="location-{{ location.id }}"
                                                   data-group-id="{{ location_group.id }}"
                                                   {% if location.id|stringformat:"s" in current_filters.locations %}checked{% endif %}
                                                   onchange="updateFilters(); updateLocationGroupState({{ location_group.id }})">
                                            <label class="form-check-label small" for="location-{{ location.id }}">
                                                {{ location.name }}
                                                {% if location.asset_count > 0 %}
                                                    <span class="text-muted">({{ location.asset_count }})</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Collection Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown" style="min-width: 150px;">
                            {% translate "Collections" %}
                            {% if current_filters.collections %}
                                <span class="badge bg-primary ms-1">{{ current_filters.collections|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 250px; max-height: 300px; overflow-y: auto;">
                            {% for collection in collections %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="collection" value="{{ collection.id }}" 
                                           id="collection-{{ collection.id }}"
                                           {% if collection.id|stringformat:"s" in current_filters.collections %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label" for="collection-{{ collection.id }}">
                                        {{ collection.name }} ({{ collection.asset_count }})
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Status Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown" style="min-width: 150px;">
                            {% translate "Status" %}
                            {% if current_filters.statuses %}
                                <span class="badge bg-primary ms-1">{{ current_filters.statuses|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 250px;">
                            {% for value, label in asset_states %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="status" value="{{ value }}" 
                                           id="status-{{ value }}"
                                           {% if value in current_filters.statuses %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label d-flex align-items-center" for="status-{{ value }}">
                                        <span class="badge me-2
                                        {% if value == 'available' %}bg-success
                                        {% elif value == 'issued_rent' or value == 'issued_loan' or value == 'issued_unprocessed' %}bg-warning
                                        {% elif value == 'maintenance_in_house' or value == 'maintenance_external' or value == 'under_review' %}bg-info
                                        {% elif value == 'placeholder' or value == 'to_be_delivered' %}bg-secondary
                                        {% elif value == 'sold' or value == 'amortized' %}bg-dark
                                        {% elif value == 'unknown' %}bg-danger
                                        {% else %}bg-primary{% endif %}" style="font-size: 0.6rem; width: 12px; height: 12px;">&nbsp;</span>
                                        {{ label }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle rounded-pill d-flex align-items-center gap-2" data-bs-toggle="dropdown" style="min-width: 200px;">
                            <span class="value-display">
                                {% translate "Price" %}: €{{ request.GET.min_value|default:"0"|floatformat:0|localize }} - €{{ request.GET.max_value|default:"10000"|floatformat:0|localize }}
                            </span>
                        </button>
                        <div class="dropdown-menu p-3" style="width: 300px;">
                            <input type="range" class="form-range mb-2" name="min_value"
                                   min="0" max="10000" step="100"
                                   value="{{ request.GET.min_value|default:'0' }}"
                                   id="valueMin">
                            <input type="range" class="form-range mb-3" name="max_value"
                                   min="0" max="10000" step="100"
                                   value="{{ request.GET.max_value|default:'10000' }}"
                                   id="valueMax">
                            <div class="d-flex justify-content-between value-labels small text-muted">
                                <div>{% translate "Min" %}: €<span id="valueMinLabel">{{ request.GET.min_value|default:"0"|floatformat:0|localize }}</span></div>
                                <div>{% translate "Max" %}: €<span id="valueMaxLabel">{{ request.GET.max_value|default:"10000"|floatformat:0|localize }}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Properties Filter -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle rounded-pill" type="button" data-bs-toggle="dropdown" style="min-width: 150px;">
                            {% translate "Properties" %}
                            {% if current_filters.property_count > 0 %}
                                <span class="badge bg-primary ms-1">{{ current_filters.property_count }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 350px; max-height: 400px; overflow-y: auto;">
                            {% for property in all_properties %}
                                <div class="mb-3">
                                    <label class="form-label fw-bold small">{{ property.name }} 
                                        <span class="text-muted">({{ property.category.name }})</span>
                                    </label>
                                    
                                    {% if property.property_type == 'dropdown' %}
                                        <div style="max-height: 120px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.25rem;">
                                            {% for option in property.get_dropdown_options %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="{{ property.slug }}" 
                                                           value="{{ option }}" 
                                                           id="property-{{ property.slug }}-{{ forloop.counter }}"
                                                           {% if option in property.current_values %}checked{% endif %}
                                                           onchange="updateFilters()">
                                                    <label class="form-check-label small" for="property-{{ property.slug }}-{{ forloop.counter }}">
                                                        {{ option }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                            {% if not property.get_dropdown_options %}
                                                <div class="text-muted small text-center py-2">
                                                    <em>{% translate "No options available" %}</em>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% elif property.property_type == 'number' %}
                                        <div class="row g-1">
                                            <div class="col-6">
                                                {% if property.unit %}
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" class="form-control" 
                                                               name="{{ property.slug }}_min" 
                                                               placeholder="{% translate 'Min' %}" step="0.01"
                                                               value="{{ property.current_min }}"
                                                               onchange="updateFilters()">
                                                        <span class="input-group-text">{{ property.unit }}</span>
                                                    </div>
                                                {% else %}
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="{{ property.slug }}_min" 
                                                           placeholder="{% translate 'Min' %}" step="0.01"
                                                           value="{{ property.current_min }}"
                                                           onchange="updateFilters()">
                                                {% endif %}
                                            </div>
                                            <div class="col-6">
                                                {% if property.unit %}
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" class="form-control" 
                                                               name="{{ property.slug }}_max" 
                                                               placeholder="{% translate 'Max' %}" step="0.01"
                                                               value="{{ property.current_max }}"
                                                               onchange="updateFilters()">
                                                        <span class="input-group-text">{{ property.unit }}</span>
                                                    </div>
                                                {% else %}
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="{{ property.slug }}_max" 
                                                           placeholder="{% translate 'Max' %}" step="0.01"
                                                           value="{{ property.current_max }}"
                                                           onchange="updateFilters()">
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                    <input type="text" class="form-control form-control-sm" 
                                           name="{{ property.slug }}" 
                                           placeholder="{% translate 'Contains text...' %}"
                                           value="{{ property.current_values.0|default:'' }}"
                                           onchange="updateFilters()">
                                    {% endif %}
                                </div>
                            {% endfor %}
                            {% if not all_properties %}
                                <div class="text-muted small text-center py-3">
                                    <em>{% translate "No properties configured yet" %}</em>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Clear Filters -->
                    <a href="{% url 'inventory_frontend:list' %}{% if request.GET.q %}?q={{ request.GET.q }}{% endif %}" class="btn btn-outline-secondary rounded-pill">
                        <i class="fas fa-times"></i> {% translate "Clear" %}
                    </a>
                    
                    </form>
                </div>
                
                <!-- View Toggle and Mobile Filter Toggle -->
                <div class="d-flex align-items-center gap-2">
                    <!-- View Toggle -->
                    <div class="btn-group" role="group">
                        <button type="button" id="grid-view-btn" class="btn btn-outline-primary active">
                            <i class="fas fa-th-large"></i><span class="d-none d-md-inline ms-1">{% translate "Grid" %}</span>
                        </button>
                        <button type="button" id="list-view-btn" class="btn btn-outline-primary">
                            <i class="fas fa-list"></i><span class="d-none d-md-inline ms-1">{% translate "List" %}</span>
                        </button>
                    </div>
                    
                    <!-- Mobile Filter Toggle -->
                    <button class="btn btn-outline-secondary d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#filter-collapse">
                        <i class="fas fa-filter"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block content %}
    <!-- Grid View -->
    <div id="grid-view" class="row g-3">
        {% for asset in assets %}
            <div class="col-12 col-md-6 col-xl-4">
                <a href="{% url 'inventory_frontend:detail' asset.id %}" class="text-decoration-none">
                    <div class="card h-100">
                        <div class="row g-0">
                            <div class="col-auto">
                                <div style="width: 120px; height: 160px;" class="position-relative">
                                    <img src="{% if asset.attachments.first %}{{ asset.attachments.first.attachment.url }}{% else %}{% static 'img/page.jpg' %}{% endif %}"
                                         alt="Asset placeholder"
                                         class="img-fluid rounded-start w-100 h-100"
                                         style="object-fit: cover;">
                                    {% if asset.attachments.count > 1 %}
                                        <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 text-white m-1" 
                                              style="font-size: 0.6rem; border-radius: 0.25rem;">
                                            <i class="fas fa-camera me-1"></i>{{ asset.attachments.count }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col">
                                <div class="card-body py-2 d-flex flex-column" style="min-height: 160px;">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5 class="card-title mb-1">{{ asset.name }}</h5>
                                            <p class="card-text text-muted mb-1">
                                                <span class="badge bg-primary">{{ asset.category.name_singular }}</span>
                                                {% if asset.size %}
                                                    <span class="badge bg-secondary">{{ asset.size }}</span>
                                                {% endif %}
                                            </p>
                                            {% if asset.location %}
                                            <p class="card-text text-muted mb-1 small">
                                                {{ asset.location }}
                                                {% if asset.location_nr %}#{{ asset.location_nr }}{% endif %}
                                            </p>
                                            {% endif %}
                                        </div>
                                        <div class="text-end purchase-price">
                                            <span class="badge 
                                            {% if asset.local_status == 'available' %}bg-success
                                            {% elif asset.local_status == 'issued_rent' or asset.local_status == 'issued_loan' or asset.local_status == 'issued_unprocessed' %}bg-warning
                                            {% elif asset.local_status == 'maintenance_in_house' or asset.local_status == 'maintenance_external' or asset.local_status == 'under_review' %}bg-info
                                            {% elif asset.local_status == 'placeholder' or asset.local_status == 'to_be_delivered' %}bg-secondary
                                            {% elif asset.local_status == 'sold' or asset.local_status == 'amortized' %}bg-dark
                                            {% elif asset.local_status == 'unknown' %}bg-danger
                                            {% else %}bg-primary{% endif %}">
                                                {{ asset.local_status }}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="mt-auto d-flex justify-content-between align-items-end">
                                        <div class="text-muted purchase-price" style="font-size: 0.75rem;">
                                            {% translate "Created" %}:<br>{{ asset.created_at|date:"d-m-Y" }}
                                        </div>
                                        <div>
                                            <small class="purchase-price">€{{ asset.purchase_value|default:0|floatformat:0 }}</small>
                                            <strong>€{{ asset.listing_price|default:0|floatformat:0 }}</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        {% empty %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">{% translate "No assets found" %}</h4>
                {% if request.GET.q %}
                    <p class="text-muted">{% blocktranslate with query=request.GET.q %}No results found for "{{ query }}"{% endblocktranslate %}</p>
                {% endif %}
                <a href="{% url 'inventory_frontend:list' %}" class="btn btn-outline-primary mt-3">{% translate "Clear all filters" %}</a>
            </div>
        {% endfor %}
    </div>

    <!-- Table View -->
    <div id="table-view" class="d-none">
        {% if assets %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>{% translate "Image" %}</th>
                            <th>{% translate "Name" %}</th>
                            <th>{% translate "Category" %}</th>
                            <th>{% translate "Location" %}</th>
                            <th class="purchase-price">{% translate "Status" %}</th>
                            <th class="purchase-price">{% translate "Purchase Price" %}</th>
                            <th>{% translate "Listing Price" %}</th>
                            <th class="purchase-price">{% translate "Created" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in assets %}
                            <tr class="clickable-row" data-href="{% url 'inventory_frontend:detail' asset.id %}" style="cursor: pointer;">
                                <td>
                                    <div class="position-relative d-inline-block">
                                        <img src="{% if asset.attachments.first %}{{ asset.attachments.first.attachment.url }}{% else %}{% static 'img/page.jpg' %}{% endif %}"
                                             alt="Asset thumbnail"
                                             class="img-thumbnail"
                                             style="width: 50px; height: 50px; object-fit: cover;">
                                        {% if asset.attachments.count > 1 %}
                                            <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 text-white" 
                                                  style="font-size: 0.5rem; border-radius: 0.2rem; margin: 2px;">
                                                <i class="fas fa-camera me-1"></i>{{ asset.attachments.count }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ asset.name }}</strong>
                                    {% if asset.size %}
                                        <br><small class="text-muted">{{ asset.size }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ asset.category.name_singular }}</span>
                                </td>
                                <td>
                                    {% if asset.location %}
                                        {{ asset.location }}
                                        {% if asset.location_nr %}<br><small class="text-muted">#{{ asset.location_nr }}</small>{% endif %}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="purchase-price">
                                    <span class="badge 
                                    {% if asset.local_status == 'available' %}bg-success
                                    {% elif asset.local_status == 'issued_rent' or asset.local_status == 'issued_loan' or asset.local_status == 'issued_unprocessed' %}bg-warning
                                    {% elif asset.local_status == 'maintenance_in_house' or asset.local_status == 'maintenance_external' or asset.local_status == 'under_review' %}bg-info
                                    {% elif asset.local_status == 'placeholder' or asset.local_status == 'to_be_delivered' %}bg-secondary
                                    {% elif asset.local_status == 'sold' or asset.local_status == 'amortized' %}bg-dark
                                    {% elif asset.local_status == 'unknown' %}bg-danger
                                    {% else %}bg-primary{% endif %}">
                                        {{ asset.local_status }}
                                    </span>
                                </td>
                                <td class="purchase-price">€{{ asset.purchase_value|default:0|floatformat:0 }}</td>
                                <td><strong>€{{ asset.listing_price|default:0|floatformat:0 }}</strong></td>
                                <td class="purchase-price">
                                    <small>{{ asset.created_at|date:"d-m-Y" }}</small>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">{% translate "No assets found" %}</h4>
                {% if request.GET.q %}
                    <p class="text-muted">{% blocktranslate with query=request.GET.q %}No results found for "{{ query }}"{% endblocktranslate %}</p>
                {% endif %}
                <a href="{% url 'inventory_frontend:list' %}" class="btn btn-outline-primary mt-3">{% translate "Clear all filters" %}</a>
            </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% comment %} Smart pagination with page ranges {% endcomment %}
                {% if page_obj.number > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">1</a>
                    </li>
                    {% if page_obj.number > 4 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.number < page_obj.paginator.num_pages|add:"-2" %}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:"-3" %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ page_obj.paginator.num_pages }}</a>
                    </li>
                {% endif %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
            
            <div class="text-center mt-2">
                <small class="text-muted">
                    {% blocktranslate with current=page_obj.number total=page_obj.paginator.num_pages count=page_obj.paginator.count %}Page {{ current }} of {{ total }} ({{ count }} total items){% endblocktranslate %}
                </small>
            </div>
        </nav>
    {% endif %}
{% endblock %}

{% block body_js %}
<script>
console.log('List.html JavaScript loading...');

// Make sure updateFilters is available immediately
function updateFilters() {
    const form = document.getElementById('filter-form');
    if (!form) {
        console.error('filter-form not found');
        return;
    }
    
    // Clean up hidden property filter inputs to ensure only current values are sent
    const hiddenPropertyInputs = form.querySelectorAll('input[type="hidden"]');
    hiddenPropertyInputs.forEach(input => {
        // Remove hidden inputs for property slugs (but keep search query)
        if (input.name !== 'q' && input.name !== 'csrfmiddlewaretoken') {
            input.remove();
        }
    });
    
    // Remove empty form inputs to clean up URL parameters
    const formInputs = form.querySelectorAll('input, select');
    formInputs.forEach(input => {
        if (input.type === 'hidden') return; // Skip hidden inputs
        
        if (input.type === 'checkbox' && !input.checked) {
            input.disabled = true;
        } else if (input.type !== 'checkbox' && input.type !== 'range' && (!input.value || input.value.trim() === '')) {
            input.disabled = true;
        } else if (input.type === 'range') {
            // Disable range inputs with default values
            if ((input.name === 'min_value' && input.value === '0') ||
                (input.name === 'max_value' && input.value === '10000')) {
                input.disabled = true;
            }
        }
    });
    
    form.submit();
}

// Make toggleLocationGroup available globally  
function toggleLocationGroup(groupId) {
    const groupCheckbox = document.getElementById(`location-group-${groupId}`);
    const locationCheckboxes = document.querySelectorAll(`input[data-group-id="${groupId}"].location-checkbox`);
    
    if (!groupCheckbox) {
        console.error('Group checkbox not found:', `location-group-${groupId}`);
        return;
    }
    
    const isChecked = groupCheckbox.checked;
    
    // Set all locations in this group to match the group checkbox state
    locationCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
    
    // Update filters
    updateFilters();
}

/**
 * Initialize page functionality
 */
document.addEventListener('DOMContentLoaded', function() {
    initializeViewToggle();
    initializeMultiSelectFilters();
    initializePriceRangeSliders();
    initializeAutocomplete();
    initializeClickableRows();
    initializeLocationGroups();
});

/**
 * View toggle functionality (grid/list)
 */
function initializeViewToggle() {
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listViewBtn = document.getElementById('list-view-btn');
    const gridView = document.getElementById('grid-view');
    const tableView = document.getElementById('table-view');

    if (!gridViewBtn || !listViewBtn || !gridView || !tableView) {
        console.warn('View toggle elements not found');
        return;
    }

    gridViewBtn.addEventListener('click', function(e) {
        e.preventDefault();
        gridView.classList.remove('d-none');
        tableView.classList.add('d-none');
        gridViewBtn.classList.add('active');
        listViewBtn.classList.remove('active');
        localStorage.setItem('preferred-view', 'grid');
    });

    listViewBtn.addEventListener('click', function(e) {
        e.preventDefault();
        gridView.classList.add('d-none');
        tableView.classList.remove('d-none');
        listViewBtn.classList.add('active');
        gridViewBtn.classList.remove('active');
        localStorage.setItem('preferred-view', 'table');
    });

    // Restore preferred view
    const preferredView = localStorage.getItem('preferred-view');
    if (preferredView === 'table') {
        listViewBtn.click();
    }
}

/**
 * Multi-select filter functionality
 */
function initializeMultiSelectFilters() {
    // Keep filter dropdowns open when clicking checkboxes
    document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
        dropdown.addEventListener('click', function(e) {
            if (e.target.matches('input[type="checkbox"]') || 
                e.target.matches('.form-check-label') || 
                e.target.matches('.form-check')) {
                e.stopPropagation();
            }
        });
    });
}

/**
 * Price range slider functionality
 */
function initializePriceRangeSliders() {
    const valueMin = document.getElementById('valueMin');
    const valueMax = document.getElementById('valueMax');
    const valueMinLabel = document.getElementById('valueMinLabel');
    const valueMaxLabel = document.getElementById('valueMaxLabel');
    const valueDisplay = document.querySelector('.value-display');

    if (!valueMin || !valueMax || !valueMinLabel || !valueMaxLabel || !valueDisplay) return;

    function updateValueLabels() {
        const minValue = Number(valueMin.value).toLocaleString('nl-NL');
        const maxValue = Number(valueMax.value).toLocaleString('nl-NL');
        valueMinLabel.textContent = minValue;
        valueMaxLabel.textContent = maxValue;
        valueDisplay.textContent = '{% translate "Price" %}: €' + minValue + ' - €' + maxValue;
    }

    function updateForm() {
        const form = document.getElementById('filter-form');
        if (form) {
            form.submit();
        }
    }

    let timeout;
    valueMin.addEventListener('input', function() {
        if (parseInt(valueMin.value) > parseInt(valueMax.value)) {
            valueMin.value = valueMax.value;
        }
        updateValueLabels();
        clearTimeout(timeout);
        timeout = setTimeout(updateForm, 500);
    });

    valueMax.addEventListener('input', function() {
        if (parseInt(valueMax.value) < parseInt(valueMin.value)) {
            valueMax.value = valueMin.value;
        }
        updateValueLabels();
        clearTimeout(timeout);
        timeout = setTimeout(updateForm, 500);
    });

    // Keep dropdown open while interacting with sliders
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        dropdown.addEventListener('click', function(e) {
            if (e.target.matches('input[type="range"]')) {
                e.stopPropagation();
            }
        });
    });

    // Initialize with current values
    updateValueLabels();
}

/**
 * Autocomplete functionality
 */
function initializeAutocomplete() {
    const searchInput = document.getElementById('search-input');
    const suggestionsDiv = document.getElementById('autocomplete-suggestions');

    if (!searchInput || !suggestionsDiv) return;

    let autocompleteTimeout;
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function fetchSuggestions(query) {
        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        
        fetch('{% url 'inventory_frontend:autocomplete' %}?q=' + encodeURIComponent(query), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(suggestions => {
            if (suggestions && suggestions.length > 0) {
                showSuggestions(suggestions);
            } else {
                suggestionsDiv.style.display = 'none';
            }
                })
                .catch(error => {
                    console.error('Autocomplete error:', error);
                    suggestionsDiv.style.display = 'none';
                });
        }

        function showSuggestions(suggestions) {
            suggestionsDiv.innerHTML = '';
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'p-3 border-bottom';
                div.style.cursor = 'pointer';
                
                // Create rich suggestion HTML
                let locationText = '';
                if (suggestion.location) {
                    locationText = suggestion.location;
                    if (suggestion.location_nr) {
                        locationText += ` #${suggestion.location_nr}`;
                    }
                }
                
                // Check customer mode
                const isCustomerMode = getCookie('customer_mode') === 'true';
                
                // Build HTML without template literals to avoid conflicts
                let html = '<div class="d-flex justify-content-between align-items-start">';
                html += '<div class="flex-grow-1">';
                html += '<div class="fw-bold text-dark">' + suggestion.name + '</div>';
                html += '<div class="small text-muted d-flex gap-2 flex-wrap">';
                
                if (suggestion.category) {
                    html += '<span class="badge bg-primary">' + suggestion.category + '</span>';
                }
                if (suggestion.size) {
                    html += '<span class="badge bg-secondary">' + suggestion.size + '</span>';
                }
                if (locationText) {
                    html += '<span class="text-muted">' + locationText + '</span>';
                }
                if (!isCustomerMode && suggestion.created_at) {
                    html += '<span class="text-muted">Created: ' + suggestion.created_at + '</span>';
                }
                
                html += '</div></div>';
                html += '<div class="text-end ms-2">';
                
                if (!isCustomerMode) {
                    html += '<div class="small text-muted purchase-price">Purchase: €' + suggestion.purchase_value.toFixed(0) + '</div>';
                }
                html += '<div class="fw-bold text-success">€' + suggestion.listing_price.toFixed(0) + '</div>';
                html += '</div></div>';
                
                div.innerHTML = html;
                
                div.addEventListener('click', function() {
                    suggestionsDiv.style.display = 'none';
                    window.location.href = '/new/' + suggestion.id + '/';
                });
                
                div.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                
                div.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
                
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.style.display = 'block';
        }

        // Set up input event listener
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            clearTimeout(autocompleteTimeout);
            
            if (query.length >= 2) {
                autocompleteTimeout = setTimeout(() => fetchSuggestions(query), 300);
            } else {
                suggestionsDiv.style.display = 'none';
            }
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                fetchSuggestions(this.value.trim());
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
}

/**
 * Clickable table rows functionality
 */
function initializeClickableRows() {
    const clickableRows = document.querySelectorAll('.clickable-row');
    
    clickableRows.forEach(row => {
        row.addEventListener('click', function() {
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
        
        // Add hover effects
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.style.transform = 'scale(1.01)';
            this.style.transition = 'all 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.transform = '';
        });
    });
}

/**
 * Location group functionality
 */
function initializeLocationGroups() {
    // Initialize location group states on page load
    document.querySelectorAll('.location-group-checkbox').forEach(groupCheckbox => {
        const groupId = groupCheckbox.getAttribute('data-group-id');
        updateLocationGroupState(groupId);
    });
}

/**
 * Location group state management
 */

function updateLocationGroupState(groupId) {
    const groupCheckbox = document.getElementById(`location-group-${groupId}`);
    const locationCheckboxes = document.querySelectorAll(`input[data-group-id="${groupId}"].location-checkbox`);
    
    if (!groupCheckbox || locationCheckboxes.length === 0) return;
    
    const checkedLocations = Array.from(locationCheckboxes).filter(cb => cb.checked);
    
    if (checkedLocations.length === 0) {
        // No locations checked - group unchecked
        groupCheckbox.checked = false;
        groupCheckbox.indeterminate = false;
    } else if (checkedLocations.length === locationCheckboxes.length) {
        // All locations checked - group checked
        groupCheckbox.checked = true;
        groupCheckbox.indeterminate = false;
    } else {
        // Some locations checked - group indeterminate
        groupCheckbox.checked = false;
        groupCheckbox.indeterminate = true;
    }
}
</script>
{% endblock %}
