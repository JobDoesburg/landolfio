{% extends "page-no-header.html" %}
{% load static i18n l10n dict_extras %}

{% block header %}
    <!-- Mobile Search Header -->
    <div class="d-md-none py-3">
        <form action="{% url 'inventory_frontend:list' %}" method="get" class="d-flex gap-2 align-items-center">
            <a href="{% url 'inventory_frontend:search' %}">
                <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height: 32px;">
            </a>
            <div class="flex-grow-1 position-relative">
                <input type="text" name="q" id="search-input-mobile" class="form-control"
                       placeholder="{% translate 'Search...' %}"
                       value="{{ request.GET.q|default:'' }}"
                       autocomplete="off">
                <div id="autocomplete-suggestions-mobile" class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 300px; overflow-y: auto;"></div>
                <button type="submit" class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2">
                    <i class="fas fa-search text-muted"></i>
                </button>
            </div>
            <a href="{% url 'inventory_frontend:create' %}" class="btn btn-success">
                <i class="fas fa-plus"></i>
            </a>
            <a href="{% url 'inventory_frontend:bulk_update' %}" class="btn btn-primary">
                <i class="fas fa-layer-group"></i>
            </a>
            <div class="btn-group" role="group">
                <a href="{% url 'admin:index' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-cog"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary customer-mode-toggle" title="{% translate 'Toggle Customer Mode' %}">
                    <i class="fas fa-user-tie"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Desktop Search Header -->
    <div class="d-none d-md-block py-4">
        <form action="{% url 'inventory_frontend:list' %}" method="get" class="d-flex gap-3 align-items-center">
            <a href="{% url 'inventory_frontend:search' %}">
                <img src="{% static 'img/logo.png' %}" alt="Logo" class="img-fluid" style="max-height: 38px;">
            </a>
            <div class="flex-grow-1 position-relative">
                <input type="text" name="q" id="search-input" class="form-control"
                       placeholder="{% translate 'Search...' %}"
                       value="{{ request.GET.q|default:'' }}"
                       autocomplete="off">
                <div id="autocomplete-suggestions" class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 400px; overflow-y: auto;"></div>
                <button type="submit" class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2">
                    <i class="fas fa-search text-muted"></i>
                </button>
            </div>
            <a href="{% url 'inventory_frontend:create' %}" class="btn btn-success">
                <i class="fas fa-plus"></i><span class="ms-2 d-none d-xl-inline">{% translate "New" %}</span>
            </a>
            <a href="{% url 'inventory_frontend:bulk_update' %}" class="btn btn-primary">
                <i class="fas fa-layer-group"></i><span class="ms-2 d-none d-xl-inline">{% translate "Bulk update" %}</span>
            </a>
            <div class="input-group" style="width: auto;">
                <button type="button" id="grid-view-btn" class="btn btn-outline-primary active">
                    <i class="fas fa-th-large"></i><span class="ms-1 d-none d-xl-inline">{% translate "Grid" %}</span>
                </button>
                <button type="button" id="list-view-btn" class="btn btn-outline-primary">
                    <i class="fas fa-list"></i><span class="ms-1 d-none d-xl-inline">{% translate "List" %}</span>
                </button>
                <select class="form-select" style="width: auto;" id="page-size-selector" onchange="changePageSize(this.value)">
                    <option value="12" {% if request.GET.page_size == '12' or not request.GET.page_size %}selected{% endif %}>12</option>
                    <option value="24" {% if request.GET.page_size == '24' %}selected{% endif %}>24</option>
                    <option value="48" {% if request.GET.page_size == '48' %}selected{% endif %}>48</option>
                    <option value="96" {% if request.GET.page_size == '96' %}selected{% endif %}>96</option>
                </select>
            </div>
            <div class="btn-group" role="group">
                <a href="{% url 'admin:index' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-cog"></i>
                </a>
                <button type="button" class="btn btn-outline-secondary customer-mode-toggle" title="{% translate 'Toggle Customer Mode' %}">
                    <i class="fas fa-user-tie"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- Mobile Filter Toggle Row -->
    <div class="row mb-2 d-md-none">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-outline-secondary" type="button" onclick="toggleFilters()">
                    <i class="fas fa-filter me-2"></i>{% translate "Filters" %}
                </button>
                <div class="input-group" style="width: auto;">
                    <button type="button" id="grid-view-btn-mobile" class="btn btn-outline-primary active">
                        <i class="fas fa-th-large"></i>
                    </button>
                    <button type="button" id="list-view-btn-mobile" class="btn btn-outline-primary">
                        <i class="fas fa-list"></i>
                    </button>
                    <select class="form-select" style="width: auto;" id="page-size-selector-mobile" onchange="changePageSize(this.value)">
                        <option value="12" {% if request.GET.page_size == '12' or not request.GET.page_size %}selected{% endif %}>12</option>
                        <option value="24" {% if request.GET.page_size == '24' %}selected{% endif %}>24</option>
                        <option value="48" {% if request.GET.page_size == '48' %}selected{% endif %}>48</option>
                        <option value="96" {% if request.GET.page_size == '96' %}selected{% endif %}>96</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls Row -->
    <div class="row mb-2">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center gap-3">
                <!-- Single Filter Form (responsive) -->
                <form method="get" id="filter-collapse" class="d-md-flex flex-wrap gap-2 flex-grow-1 mb-4">
                    <!-- Preserve search query -->
                    {% if request.GET.q %}
                        <input type="hidden" name="q" value="{{ request.GET.q }}">
                    {% endif %}
                    
                    <!-- Preserve property filters -->
                    {% for property in all_properties %}
                        {% for value in property.current_values %}
                            <input type="hidden" name="{{ property.slug }}" value="{{ value }}">
                        {% endfor %}
                        {% if property.property_type == 'number' %}
                            {% if property.current_min %}
                                <input type="hidden" name="{{ property.slug }}_min" value="{{ property.current_min }}">
                            {% endif %}
                            {% if property.current_max %}
                                <input type="hidden" name="{{ property.slug }}_max" value="{{ property.current_max }}">
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    <!-- Category Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {% translate "Categories" %}
                            {% if current_filters.categories %}
                                <span class="badge bg-primary ms-1">{{ current_filters.categories|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 250px; max-height: 300px; overflow-y: auto;">
                            {% for category in categories %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="category" value="{{ category.id }}" 
                                           id="category-{{ category.id }}" 
                                           {% if category.id|stringformat:"s" in current_filters.categories %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label" for="category-{{ category.id }}">
                                        {{ category.name }} ({{ category.asset_count }})
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Size Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {% translate "Sizes" %}
                            {% if current_filters.sizes %}
                                <span class="badge bg-primary ms-1">{{ current_filters.sizes|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 200px; max-height: 300px; overflow-y: auto;">
                            {% for size in sizes %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="size" value="{{ size.id }}" 
                                           id="size-{{ size.id }}" 
                                           {% if size.id|stringformat:"s" in current_filters.sizes %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label" for="size-{{ size.id }}">
                                        {{ size.name }} ({{ size.asset_count }})
                                    </label>
                                </div>
                            {% endfor %}
                            {% if not sizes %}
                                <div class="text-muted small text-center py-2">
                                    <em>{% translate "No sizes available" %}</em>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Location Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {% translate "Locations" %}
                            {% if current_filters.locations %}
                                <span class="badge bg-primary ms-1">{{ current_filters.locations|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 280px; max-height: 400px; overflow-y: auto;">
                            {% for location_group in location_groups %}
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input location-group-checkbox" type="checkbox" 
                                               id="location-group-{{ location_group.id }}" 
                                               data-group-id="{{ location_group.id }}"
                                               onchange="toggleLocationGroup({{ location_group.id }})">
                                        <label class="form-check-label fw-bold text-dark small" for="location-group-{{ location_group.id }}">
                                            {{ location_group.name }}
                                            {% if location_group.asset_count > 0 %}
                                                <span class="badge bg-primary text-white ms-1">{{ location_group.asset_count }}</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    <div class="border-bottom mb-2"></div>
                                    {% for location in location_group.location_set.all %}
                                        <div class="form-check ms-3">
                                            <input class="form-check-input location-checkbox" type="checkbox" name="location" value="{{ location.id }}" 
                                                   id="location-{{ location.id }}"
                                                   data-group-id="{{ location_group.id }}"
                                                   {% if location.id|stringformat:"s" in current_filters.locations %}checked{% endif %}
                                                   onchange="updateFilters(); updateLocationGroupState({{ location_group.id }})">
                                            <label class="form-check-label small" for="location-{{ location.id }}">
                                                {{ location.name }}
                                                {% if location.asset_count > 0 %}
                                                    <span class="text-muted">({{ location.asset_count }})</span>
                                                {% endif %}
                                            </label>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Collection Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {% translate "Collections" %}
                            {% if current_filters.collections %}
                                <span class="badge bg-primary ms-1">{{ current_filters.collections|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 250px; max-height: 300px; overflow-y: auto;">
                            {% for collection in collections %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="collection" value="{{ collection.id }}" 
                                           id="collection-{{ collection.id }}"
                                           {% if collection.id|stringformat:"s" in current_filters.collections %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label" for="collection-{{ collection.id }}">
                                        {{ collection.name }} ({{ collection.asset_count }})
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Status Multi-Select -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {% translate "Status" %}
                            {% if current_filters.statuses %}
                                <span class="badge bg-primary ms-1">{{ current_filters.statuses|length }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 250px; max-height: 400px; overflow-y: auto;">
                            {% for status_type in active_status_types %}
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="status" value="{{ status_type.slug }}"
                                           id="status-{{ status_type.slug }}"
                                           {% if status_type.slug in current_filters.statuses %}checked{% endif %}
                                           onchange="updateFilters()">
                                    <label class="form-check-label d-flex align-items-center" for="status-{{ status_type.slug }}">
                                        <span class="badge me-2" style="font-size: 0.6rem; width: 12px; height: 12px; background-color: {{ status_type.background_color }};">&nbsp;</span>
                                        {{ status_type.name }}
                                    </label>
                                </div>
                            {% endfor %}

                            {% if archived_status_types %}
                                <div class="border-top mt-2 pt-2">
                                    <div class="form-check mb-2">
                                        <input class="form-check-input archived-group-checkbox" type="checkbox"
                                               id="include-archived"
                                               onchange="toggleArchivedGroup()">
                                        <label class="form-check-label fw-bold small text-muted" for="include-archived">
                                            {% translate "Archived" %}
                                        </label>
                                    </div>
                                    <div id="archived-statuses" class="ms-3">
                                        {% for status_type in archived_status_types %}
                                            <div class="form-check">
                                                <input class="form-check-input archived-status" type="checkbox" name="status" value="{{ status_type.slug }}"
                                                       id="status-{{ status_type.slug }}"
                                                       {% if status_type.slug in current_filters.statuses %}checked{% endif %}
                                                       onchange="updateFilters(); updateArchivedGroupState()">
                                                <label class="form-check-label d-flex align-items-center small text-muted" for="status-{{ status_type.slug }}">
                                                    <span class="badge me-2" style="font-size: 0.6rem; width: 12px; height: 12px; background-color: {{ status_type.background_color }};">&nbsp;</span>
                                                    {{ status_type.name }}
                                                </label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle d-flex align-items-center gap-2" data-bs-toggle="dropdown">
                            <span class="value-display">
                                {% translate "Price" %}: €{{ request.GET.min_value|default:"0"|floatformat:0|localize }} - €{{ request.GET.max_value|default:"10000"|floatformat:0|localize }}
                            </span>
                        </button>
                        <div class="dropdown-menu p-3" style="width: 300px;">
                            <input type="range" class="form-range mb-2" name="min_value"
                                   min="0" max="10000" step="100"
                                   value="{{ request.GET.min_value|default:'0' }}"
                                   id="valueMin">
                            <input type="range" class="form-range mb-3" name="max_value"
                                   min="0" max="10000" step="100"
                                   value="{{ request.GET.max_value|default:'10000' }}"
                                   id="valueMax">
                            <div class="d-flex justify-content-between value-labels small text-muted">
                                <div>{% translate "Min" %}: €<span id="valueMinLabel">{{ request.GET.min_value|default:"0"|floatformat:0|localize }}</span></div>
                                <div>{% translate "Max" %}: €<span id="valueMaxLabel">{{ request.GET.max_value|default:"10000"|floatformat:0|localize }}</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Properties Filter -->
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            {% translate "Properties" %}
                            {% if current_filters.property_count > 0 %}
                                <span class="badge bg-primary ms-1">{{ current_filters.property_count }}</span>
                            {% endif %}
                        </button>
                        <div class="dropdown-menu p-2" style="width: 350px; max-height: 400px; overflow-y: auto;">
                            {% for property in all_properties %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <label class="form-label fw-bold small mb-0">{{ property.name }}</label>
                                        <i class="fas fa-eye property-visibility-toggle property-eye-icon" 
                                           style="cursor: pointer; color: #6c757d; font-size: 0.8rem;"
                                           data-property-slug="{{ property.slug }}"
                                           data-property-name="{{ property.name }}"
                                           title="Toggle property visibility in views"
                                           onclick="togglePropertyVisibility('{{ property.slug }}', '{{ property.name }}')"></i>
                                    </div>
                                    
                                    {% if property.property_type == 'dropdown' %}
                                        <div style="max-height: 120px; overflow-y: auto; border: 1px solid #ced4da; border-radius: 0.375rem; padding: 0.25rem;">
                                            {% for option in property.get_dropdown_options %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="{{ property.slug }}" 
                                                           value="{{ option }}" 
                                                           id="property-{{ property.slug }}-{{ forloop.counter }}"
                                                           {% if option in property.current_values %}checked{% endif %}
                                                           onchange="updateFilters()">
                                                    <label class="form-check-label small" for="property-{{ property.slug }}-{{ forloop.counter }}">
                                                        {{ option }}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                            {% if not property.get_dropdown_options %}
                                                <div class="text-muted small text-center py-2">
                                                    <em>{% translate "No options available" %}</em>
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% elif property.property_type == 'number' %}
                                        <div class="row g-1">
                                            <div class="col-6">
                                                {% if property.unit %}
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" class="form-control" 
                                                               name="{{ property.slug }}_min" 
                                                               placeholder="{% translate 'Min' %}" step="0.01"
                                                               value="{{ property.current_min }}"
                                                               onchange="updateFilters()">
                                                        <span class="input-group-text">{{ property.unit }}</span>
                                                    </div>
                                                {% else %}
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="{{ property.slug }}_min" 
                                                           placeholder="{% translate 'Min' %}" step="0.01"
                                                           value="{{ property.current_min }}"
                                                           onchange="updateFilters()">
                                                {% endif %}
                                            </div>
                                            <div class="col-6">
                                                {% if property.unit %}
                                                    <div class="input-group input-group-sm">
                                                        <input type="number" class="form-control" 
                                                               name="{{ property.slug }}_max" 
                                                               placeholder="{% translate 'Max' %}" step="0.01"
                                                               value="{{ property.current_max }}"
                                                               onchange="updateFilters()">
                                                        <span class="input-group-text">{{ property.unit }}</span>
                                                    </div>
                                                {% else %}
                                                    <input type="number" class="form-control form-control-sm" 
                                                           name="{{ property.slug }}_max" 
                                                           placeholder="{% translate 'Max' %}" step="0.01"
                                                           value="{{ property.current_max }}"
                                                           onchange="updateFilters()">
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% else %}
                                    <input type="text" class="form-control form-control-sm" 
                                           name="{{ property.slug }}" 
                                           placeholder="{% translate 'Contains text...' %}"
                                           value="{{ property.current_values.0|default:'' }}"
                                           onchange="updateFilters()">
                                    {% endif %}
                                </div>
                            {% endfor %}
                            {% if not all_properties %}
                                <div class="text-muted small text-center py-3">
                                    <em>{% translate "No properties configured yet" %}</em>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Clear Filters (only show if filters are active) -->
                    {% if current_filters.categories or current_filters.sizes or current_filters.locations or current_filters.collections or current_filters.statuses or current_filters.min_value or current_filters.max_value or current_filters.property_count > 0 %}
                        <a href="{% url 'inventory_frontend:list' %}{% if request.GET.q %}?q={{ request.GET.q }}{% endif %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times"></i> {% translate "Clear" %}
                        </a>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block extrastyle %}
<style>
    /* Always use flex layout for filter form */
    #filter-collapse {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        transition: height 0.3s ease;
    }
    
    /* Only hide overflow during animation on mobile */
    @media (max-width: 767.98px) {
        #filter-collapse.animating {
            overflow: hidden;
        }
    }
    
    /* On desktop, always show */
    @media (min-width: 768px) {
        #filter-collapse {
            display: flex !important;
            height: auto !important;
        }
    }
    
    /* Mobile hidden state - applied by JavaScript after initialization */
    #filter-collapse.mobile-hidden {
        display: none;
        height: 0;
    }
    
    /* Grid card improvements */
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: 1px solid rgba(0, 0, 0, 0.08);
        height: 100%;
    }
    
    /* Ensure all columns in the grid have equal height */
    #grid-view .row {
        display: flex;
        flex-wrap: wrap;
        align-items: stretch;
    }
    
    #grid-view [class*="col-"] {
        display: flex !important;
        flex-direction: column;
    }
    
    #grid-view .card {
        flex: 1;
        min-height: 160px;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Image styling - full height coverage */
    .card .col-auto {
        display: flex;
        flex-direction: column;
    }
    
    .card .col-auto .position-relative {
        overflow: hidden;
        border-radius: 0.375rem 0 0 0.375rem;
        height: 100%;
        display: flex;
    }
    
    .card .col-auto img {
        width: 90px;
        height: 100%;
        object-fit: cover;
    }
    
    /* Card body should use flexbox for content distribution and match thumbnail height */
    .card .card-body {
        justify-content: space-between;
        height: 100%;
    }
    
    /* Ensure the column containing card body takes full height */
    .card .row .col {
        display: flex;
        flex-direction: column;
    }
    
    @media (max-width: 767.98px) {
        .card .col-auto img {
            width: 75px;
        }
    }
    
    @media (min-width: 1200px) {
        .card .col-auto img {
            width: 105px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Grid View -->
    <div id="grid-view" class="row g-3">
        {% for asset in assets %}
            <div class="col-12 col-md-6 col-xl-4 col-xxl-3">
                <div class="card h-100 shadow-sm clickable-card" data-href="{% url 'inventory_frontend:detail' asset.id %}" style="cursor: pointer;">
                    <div class="row g-0 h-100">
                        <div class="col-auto">
                            <div class="position-relative">
                                <img src="{% if asset.attachments.first %}{{ asset.attachments.first.attachment.url }}{% else %}{% static 'img/page.jpg' %}{% endif %}"
                                     alt="Asset placeholder"
                                     class="img-fluid rounded-start"
                                     style="object-fit: cover;">
                                {% if asset.attachments.count > 1 %}
                                    <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 text-white m-1" 
                                          style="font-size: 0.55rem; border-radius: 0.25rem;">
                                        <i class="fas fa-camera me-1"></i>{{ asset.attachments.count }}
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col">
                            <div class="card-body py-2 px-3 d-flex flex-column">
                                <!-- Top Content -->
                                <div class="flex-grow-1">
                                    <!-- Asset Name -->
                                    <h4 class="card-title mb-1 fw-bold" style="line-height: 1.2;">{{ asset.name }}</h4>

                                    <!-- Badges Section -->
                                    <div class="d-flex flex-wrap gap-1 mb-2">
                                        <span class="badge bg-primary" style="font-size: 0.6rem; white-space: nowrap;">{{ asset.category.name_singular }}</span>
                                        {% if asset.size %}
                                            <span class="badge bg-secondary" style="font-size: 0.6rem; white-space: nowrap;">{{ asset.size }}</span>
                                        {% endif %}
                                        <span class="badge
                                        {% if asset.current_status == 'available' %}bg-success
                                        {% elif asset.current_status == 'issued_rent' or asset.current_status == 'issued_loan' or asset.current_status == 'issued_unprocessed' %}bg-warning
                                        {% elif asset.current_status == 'maintenance_in_house' or asset.current_status == 'maintenance_external' or asset.current_status == 'under_review' %}bg-info
                                        {% elif asset.current_status == 'placeholder' %}bg-light text-dark{% elif asset.current_status == 'to_be_delivered' %}bg-secondary
                                        {% elif asset.current_status == 'sold' %}bg-secondary{% elif asset.current_status == 'amortized' %}bg-dark
                                        {% elif asset.current_status == 'unknown' %}bg-danger
                                        {% else %}bg-primary{% endif %}" style="font-size: 0.6rem; white-space: nowrap;">
                                            {{ asset.current_status_display }}
                                        </span>
                                        {% if asset.collection.commerce and asset.moneybird_asset_id %}
                                            <span class="badge bg-{{ asset.financial_status_color }} customer-mode-hide" style="font-size: 0.6rem; white-space: nowrap;">
                                                {{ asset.financial_status_display|title }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Location -->
                                    {% if asset.location %}
                                    <div class="text-muted small mb-1">
                                        <i class="fas fa-map-marker-alt me-1"></i>{{ asset.location }}{% if asset.location_nr %} #{{ asset.location_nr }}{% endif %}
                                    </div>
                                    {% endif %}
                                    
                                    
                                    <!-- Business Information Row -->
                                    <div class="d-flex align-items-center gap-2 mb-1" style="font-size: 0.65rem;">
                                    </div>
                                        
                                    <!-- Dynamic property display -->
                                    <div class="property-display-area small">
                                        {% for property in all_properties %}
                                            <div class="property-display d-none" data-property-slug="{{ property.slug }}">
                                                {% for prop_value in asset.property_values.all %}
                                                    {% if prop_value.property.slug == property.slug %}
                                                        <div class="text-muted mb-0" style="font-size: 0.7rem; line-height: 1.3;">
                                                            <strong>{{ property.name }}:</strong> 
                                                            {% if property.property_type == 'number' and property.unit %}
                                                                {{ prop_value.value }} {{ property.unit }}
                                                            {% else %}
                                                                {{ prop_value.value }}
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Bottom Section -->
                                <div class="mt-auto">
                                    <!-- Pricing row -->
                                    <div class="d-flex justify-content-between align-items-end">
                                        <div class="d-flex align-items-center gap-2">
                                            {% if asset.collection.commerce %}
                                                {% if asset.moneybird_asset_id %}
                                                    <a href="{{ asset.moneybird_asset_url }}" target="_blank" class="btn btn-outline-primary btn-sm customer-mode-hide me-1" style="font-size: 0.6rem; padding: 0.15rem 0.3rem;" title="{{ asset.moneybird_asset_name }}" onclick="event.stopPropagation();">
                                                        <i class="fas fa-external-link-alt"></i> MB
                                                    </a>
                                                {% else %}
                                                    <button class="btn btn-outline-secondary btn-sm customer-mode-hide" style="font-size: 0.6rem; padding: 0.15rem 0.3rem;" title="{% translate 'Connect to Moneybird' %}" onclick="event.stopPropagation();">
                                                        <i class="fas fa-link"></i>
                                                    </button>
                                                {% endif %}
                                            {% endif %}
                                            {% if asset.start_date %}
                                                <div class="text-muted" style="font-size: 0.7rem;">
                                                    <i class="fas fa-calendar me-1"></i>{{ asset.start_date|date:"d-m-Y" }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div class="text-end d-flex align-items-baseline gap-2">
                                            {% if asset.purchase_value_asset %}
                                                <small class="text-muted customer-mode-hide" style="font-size: 0.65rem;">€{{ asset.purchase_value_asset|floatformat:0 }}</small>
                                            {% endif %}
                                            <div class="fw-bold" style="font-size: 1.1rem; color: #198754;">
                                                €{{ asset.listing_price|default:0|floatformat:0 }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12 text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">{% translate "No assets found" %}</h4>
                {% if request.GET.q %}
                    <p class="text-muted">{% blocktranslate with query=request.GET.q %}No results found for "{{ query }}"{% endblocktranslate %}</p>
                {% endif %}
                <a href="{% url 'inventory_frontend:list' %}" class="btn btn-outline-primary mt-3">{% translate "Clear all filters" %}</a>
            </div>
        {% endfor %}
    </div>

    <!-- Table View -->
    <div id="table-view" class="d-none">
        {% if assets %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>{% translate "Image" %}</th>
                            <th>{% translate "Name" %}</th>
                            <th>{% translate "Category" %}</th>
                            <th>{% translate "Location" %}</th>
                            <th>{% translate "Listing Price" %}</th>
                            <!-- Dynamic property columns -->
                            {% for property in all_properties %}
                                <th class="property-column d-none" data-property-slug="{{ property.slug }}">
                                    {{ property.name }}
                                    {% if property.unit %}
                                        <small class="text-muted">({{ property.unit }})</small>
                                    {% endif %}
                                </th>
                            {% endfor %}
                            <th>{% translate "Status" %}</th>
                            <th class="customer-mode-hide">{% translate "Accounting" %}</th>
                            <th class="customer-mode-hide">{% translate "Purchase Price" %}</th>
                            <th class="customer-mode-hide">{% translate "Start Date" %}</th>
                            <th class="customer-mode-hide">{% translate "Created" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asset in assets %}
                            <tr class="clickable-row" data-href="{% url 'inventory_frontend:detail' asset.id %}" style="cursor: pointer;">
                                <td>
                                    <div class="position-relative d-inline-block">
                                        <img src="{% if asset.attachments.first %}{{ asset.attachments.first.attachment.url }}{% else %}{% static 'img/page.jpg' %}{% endif %}"
                                             alt="Asset thumbnail"
                                             class="img-thumbnail"
                                             style="width: 64px; height: 64px; object-fit: cover;">
                                        {% if asset.attachments.count > 1 %}
                                            <span class="position-absolute bottom-0 end-0 badge bg-dark bg-opacity-75 text-white" 
                                                  style="font-size: 0.5rem; border-radius: 0.2rem; margin: 2px;">
                                                <i class="fas fa-camera me-1"></i>{{ asset.attachments.count }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ asset.name }}</strong>
                                    {% if asset.size %}
                                        <br><small class="text-muted">{{ asset.size }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ asset.category.name_singular }}</span>
                                </td>
                                <td>
                                    {% if asset.location %}
                                        {{ asset.location }}
                                        {% if asset.location_nr %}<br><small class="text-muted">#{{ asset.location_nr }}</small>{% endif %}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td><strong>€{{ asset.listing_price|default:0|floatformat:0 }}</strong></td>
                                <!-- Dynamic property data cells -->
                                {% for property in all_properties %}
                                    <td class="property-column d-none" data-property-slug="{{ property.slug }}">
                                        {% for prop_value in asset.property_values.all %}
                                            {% if prop_value.property.slug == property.slug %}
                                                {% if property.property_type == 'number' and property.unit %}
                                                    {{ prop_value.value }} {{ property.unit }}
                                                {% else %}
                                                    {{ prop_value.value }}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    </td>
                                {% endfor %}
                                <td>
                                    <div class="d-flex flex-column gap-1">
                                        <span class="badge
                                        {% if asset.current_status == 'available' %}bg-success
                                        {% elif asset.current_status == 'issued_rent' or asset.current_status == 'issued_loan' or asset.current_status == 'issued_unprocessed' %}bg-warning
                                        {% elif asset.current_status == 'maintenance_in_house' or asset.current_status == 'maintenance_external' or asset.current_status == 'under_review' %}bg-info
                                        {% elif asset.current_status == 'placeholder' %}bg-light text-dark{% elif asset.current_status == 'to_be_delivered' %}bg-secondary
                                        {% elif asset.current_status == 'sold' %}bg-secondary{% elif asset.current_status == 'amortized' %}bg-dark
                                        {% elif asset.current_status == 'unknown' %}bg-danger
                                        {% else %}bg-primary{% endif %}" style="font-size: 0.7rem;">
                                            {{ asset.current_status_display }}
                                        </span>
                                    </div>
                                </td>

                                <td class="customer-mode-hide">
                                    {% if asset.collection.commerce %}
                                        {% if asset.moneybird_asset_id %}
                                            <div class="d-flex flex-column gap-1">
                                                <span class="badge bg-{{ asset.financial_status_color }}" style="font-size: 0.65rem;">
                                                    {{ asset.financial_status_display|title }}
                                                </span>
                                                <a href="{{ asset.moneybird_asset_url }}" target="_blank" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation();" style="font-size: 0.65rem;">
                                                    <i class="fas fa-external-link-alt"></i> {{ asset.moneybird_asset_name|truncatechars:18 }}
                                                </a>
                                            </div>
                                        {% else %}
                                            <a href="{% url 'inventory_frontend:detail' asset.pk %}#moneybirdModal" class="btn btn-sm btn-outline-secondary" title="{% translate 'Connect to Moneybird' %}" onclick="event.stopPropagation();">
                                                <i class="fas fa-link"></i>
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="customer-mode-hide">€{{ asset.purchase_value_asset|default:0|floatformat:0 }}</td>
                                <td class="customer-mode-hide">
                                    {% if asset.start_date %}
                                        <small>{{ asset.start_date|date:"d-m-Y" }}</small>
                                    {% else %}
                                        <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="customer-mode-hide">
                                    <small>{{ asset.created_at|date:"d-m-Y" }}</small>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">{% translate "No assets found" %}</h4>
                {% if request.GET.q %}
                    <p class="text-muted">{% blocktranslate with query=request.GET.q %}No results found for "{{ query }}"{% endblocktranslate %}</p>
                {% endif %}
                <a href="{% url 'inventory_frontend:list' %}" class="btn btn-outline-primary mt-3">{% translate "Clear all filters" %}</a>
            </div>
        {% endif %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>
                {% endif %}

                {% comment %} Smart pagination with page ranges {% endcomment %}
                {% if page_obj.number > 3 %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">1</a>
                    </li>
                    {% if page_obj.number > 4 %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:"-2" and num <= page_obj.number|add:"2" %}
                        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                            <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                {{ num }}
                            </a>
                        </li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.number < page_obj.paginator.num_pages|add:"-2" %}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:"-3" %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ page_obj.paginator.num_pages }}</a>
                    </li>
                {% endif %}

                {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>

            <div class="text-center mt-2">
                <small class="text-muted">
                    {% blocktranslate with current=page_obj.number total=page_obj.paginator.num_pages count=page_obj.paginator.count %}Page {{ current }} of {{ total }} ({{ count }} total items){% endblocktranslate %}
                </small>
            </div>
        </nav>
    {% endif %}
{% endblock %}

{% block body_js %}
<script>
console.log('List.html JavaScript loading...');

// Initialize mobile filter visibility
function initializeMobileFilters() {
    const form = document.getElementById('filter-collapse');
    if (!form) return;

    // On mobile, hide the form after Bootstrap initialization
    if (window.innerWidth < 768) {
        form.classList.add('mobile-hidden');
    }
}

// Custom filter toggle function
function toggleFilters() {
    const form = document.getElementById('filter-collapse');
    if (!form) return;

    const isHidden = form.classList.contains('mobile-hidden') ||
                     form.style.height === '0px' ||
                     form.style.display === 'none';

    if (isHidden) {
        // Show: remove hidden class and animate
        form.classList.remove('mobile-hidden');
        form.classList.add('animating');
        form.style.display = 'flex';
        form.style.height = '0px';

        // Get the natural height
        const scrollHeight = form.scrollHeight;

        // Trigger reflow then animate
        requestAnimationFrame(() => {
            form.style.height = scrollHeight + 'px';
        });

        // Reset height to auto after animation
        setTimeout(() => {
            form.style.height = 'auto';
            form.classList.remove('animating');
        }, 300);
    } else {
        // Hide: set explicit height, then animate to 0
        form.classList.add('animating');
        form.style.height = form.offsetHeight + 'px';

        requestAnimationFrame(() => {
            form.style.height = '0px';
        });

        // Hide completely after animation
        setTimeout(() => {
            form.style.display = 'none';
            form.classList.add('mobile-hidden');
            form.classList.remove('animating');
        }, 300);
    }
}

// Handle archived group checkbox (like location groups)
function toggleArchivedGroup() {
    const groupCheckbox = document.getElementById('include-archived');
    const archivedCheckboxes = document.querySelectorAll('.archived-status');

    const allChecked = Array.from(archivedCheckboxes).every(cb => cb.checked);
    const shouldCheck = !allChecked;

    archivedCheckboxes.forEach(cb => {
        cb.checked = shouldCheck;
    });

    updateArchivedGroupState();
    updateFilters();
}

function updateArchivedGroupState() {
    const groupCheckbox = document.getElementById('include-archived');
    const archivedCheckboxes = document.querySelectorAll('.archived-status');

    if (!groupCheckbox || archivedCheckboxes.length === 0) return;

    const checkedCount = Array.from(archivedCheckboxes).filter(cb => cb.checked).length;
    const totalCount = archivedCheckboxes.length;

    if (checkedCount === 0) {
        groupCheckbox.checked = false;
        groupCheckbox.indeterminate = false;
    } else if (checkedCount === totalCount) {
        groupCheckbox.checked = true;
        groupCheckbox.indeterminate = false;
    } else {
        groupCheckbox.checked = false;
        groupCheckbox.indeterminate = true;
    }
}

// Initialize archived group state on page load
document.addEventListener('DOMContentLoaded', function() {
    updateArchivedGroupState();
});

// Make sure updateFilters is available immediately
function updateFilters() {
    const form = document.getElementById('filter-collapse');
    if (!form) {
        console.error('filter-collapse not found');
        return;
    }

    // Clean up and submit form
    const hiddenPropertyInputs = form.querySelectorAll('input[type="hidden"]');
    hiddenPropertyInputs.forEach(input => {
        if (input.name !== 'q' && input.name !== 'csrfmiddlewaretoken') {
            input.remove();
        }
    });

    const formInputs = form.querySelectorAll('input, select');
    formInputs.forEach(input => {
        if (input.type === 'hidden') return;

        if (input.type === 'checkbox' && !input.checked) {
            input.disabled = true;
        } else if (input.type !== 'checkbox' && input.type !== 'range' && (!input.value || input.value.trim() === '')) {
            input.disabled = true;
        } else if (input.type === 'range') {
            if ((input.name === 'min_value' && input.value === '0') ||
                (input.name === 'max_value' && input.value === '10000')) {
                input.disabled = true;
            }
        }
    });

    form.submit();
}

// Property visibility management
function togglePropertyVisibility(propertySlug, propertyName) {
    const visibleProperties = getVisibleProperties();
    const isVisible = visibleProperties.includes(propertySlug);

    if (isVisible) {
        // Hide property
        hideProperty(propertySlug);
        removeFromVisibleProperties(propertySlug);
    } else {
        // Show property
        showProperty(propertySlug);
        addToVisibleProperties(propertySlug);
    }

    updatePropertyToggleIcons();
}

function showProperty(propertySlug) {
    // Show in table view
    const tableColumns = document.querySelectorAll(`th[data-property-slug="${propertySlug}"], td[data-property-slug="${propertySlug}"]`);
    tableColumns.forEach(col => col.classList.remove('d-none'));

    // Show in grid view
    const gridDisplays = document.querySelectorAll(`.property-display[data-property-slug="${propertySlug}"]`);
    gridDisplays.forEach(display => display.classList.remove('d-none'));
}

function hideProperty(propertySlug) {
    // Hide in table view
    const tableColumns = document.querySelectorAll(`th[data-property-slug="${propertySlug}"], td[data-property-slug="${propertySlug}"]`);
    tableColumns.forEach(col => col.classList.add('d-none'));

    // Hide in grid view
    const gridDisplays = document.querySelectorAll(`.property-display[data-property-slug="${propertySlug}"]`);
    gridDisplays.forEach(display => display.classList.add('d-none'));
}

function getVisibleProperties() {
    const stored = localStorage.getItem('visibleProperties');
    return stored ? JSON.parse(stored) : [];
}

function addToVisibleProperties(propertySlug) {
    const visibleProperties = getVisibleProperties();
    if (!visibleProperties.includes(propertySlug)) {
        visibleProperties.push(propertySlug);
        localStorage.setItem('visibleProperties', JSON.stringify(visibleProperties));
    }
}

function removeFromVisibleProperties(propertySlug) {
    const visibleProperties = getVisibleProperties();
    const index = visibleProperties.indexOf(propertySlug);
    if (index > -1) {
        visibleProperties.splice(index, 1);
        localStorage.setItem('visibleProperties', JSON.stringify(visibleProperties));
    }
}

function updatePropertyToggleIcons() {
    const visibleProperties = getVisibleProperties();

    document.querySelectorAll('.property-visibility-toggle').forEach(icon => {
        const propertySlug = icon.getAttribute('data-property-slug');
        const isVisible = visibleProperties.includes(propertySlug);

        if (isVisible) {
            icon.style.color = '#0d6efd'; // Bootstrap primary color
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        } else {
            icon.style.color = '#6c757d'; // Bootstrap muted color
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        }
    });
}

function initializePropertyVisibility() {
    const visibleProperties = getVisibleProperties();

    // Apply stored visibility settings
    visibleProperties.forEach(propertySlug => {
        showProperty(propertySlug);
    });

    updatePropertyToggleIcons();
}

// Make toggleLocationGroup available globally
function toggleLocationGroup(groupId) {
    const groupCheckbox = document.getElementById(`location-group-${groupId}`);
    const locationCheckboxes = document.querySelectorAll(`input[data-group-id="${groupId}"].location-checkbox`);

    if (!groupCheckbox) {
        console.error('Group checkbox not found:', `location-group-${groupId}`);
        return;
    }

    const isChecked = groupCheckbox.checked;

    // Set all locations in this group to match the group checkbox state
    locationCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });

    // Update filters
    updateFilters();
}

/**
 * Change page size
 */
function changePageSize(pageSize) {
    const url = new URL(window.location);
    url.searchParams.set('page_size', pageSize);
    url.searchParams.delete('page'); // Reset to page 1
    window.location.href = url.toString();
}

/**
 * Initialize page functionality
 */
document.addEventListener('DOMContentLoaded', function() {
    initializeMobileFilters();
    initializeViewToggle();
    initializeMultiSelectFilters();
    initializePriceRangeSliders();
    initializeAutocomplete();
    initializeClickableRows();
    initializeLocationGroups();
    initializePropertyVisibility();
    initializeClickableCards();
});

/**
 * View toggle functionality (grid/list)
 */
function initializeViewToggle() {
    const gridViewBtn = document.getElementById('grid-view-btn');
    const listViewBtn = document.getElementById('list-view-btn');
    const gridViewBtnMobile = document.getElementById('grid-view-btn-mobile');
    const listViewBtnMobile = document.getElementById('list-view-btn-mobile');
    const gridView = document.getElementById('grid-view');
    const tableView = document.getElementById('table-view');

    if (!gridView || !tableView) {
        console.warn('View elements not found');
        return;
    }

    function switchToGridView() {
        gridView.classList.remove('d-none');
        tableView.classList.add('d-none');
        
        // Update both desktop and mobile buttons
        if (gridViewBtn) {
            gridViewBtn.classList.add('active');
        }
        if (listViewBtn) {
            listViewBtn.classList.remove('active');
        }
        if (gridViewBtnMobile) {
            gridViewBtnMobile.classList.add('active');
        }
        if (listViewBtnMobile) {
            listViewBtnMobile.classList.remove('active');
        }
        
        localStorage.setItem('preferred-view', 'grid');
    }

    function switchToListView() {
        gridView.classList.add('d-none');
        tableView.classList.remove('d-none');
        
        // Update both desktop and mobile buttons
        if (gridViewBtn) {
            gridViewBtn.classList.remove('active');
        }
        if (listViewBtn) {
            listViewBtn.classList.add('active');
        }
        if (gridViewBtnMobile) {
            gridViewBtnMobile.classList.remove('active');
        }
        if (listViewBtnMobile) {
            listViewBtnMobile.classList.add('active');
        }
        
        localStorage.setItem('preferred-view', 'table');
    }

    // Add event listeners for desktop buttons
    if (gridViewBtn) {
        gridViewBtn.addEventListener('click', function(e) {
            e.preventDefault();
            switchToGridView();
        });
    }

    if (listViewBtn) {
        listViewBtn.addEventListener('click', function(e) {
            e.preventDefault();
            switchToListView();
        });
    }

    // Add event listeners for mobile buttons
    if (gridViewBtnMobile) {
        gridViewBtnMobile.addEventListener('click', function(e) {
            e.preventDefault();
            switchToGridView();
        });
    }

    if (listViewBtnMobile) {
        listViewBtnMobile.addEventListener('click', function(e) {
            e.preventDefault();
            switchToListView();
        });
    }

    // Restore preferred view
    const preferredView = localStorage.getItem('preferred-view');
    if (preferredView === 'table') {
        switchToListView();
    }
}

/**
 * Multi-select filter functionality
 */
function initializeMultiSelectFilters() {
    // Keep filter dropdowns open when clicking checkboxes
    document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
        dropdown.addEventListener('click', function(e) {
            if (e.target.matches('input[type="checkbox"]') || 
                e.target.matches('.form-check-label') || 
                e.target.matches('.form-check')) {
                e.stopPropagation();
            }
        });
    });
}

/**
 * Price range slider functionality
 */
function initializePriceRangeSliders() {
    const valueMin = document.getElementById('valueMin');
    const valueMax = document.getElementById('valueMax');
    const valueMinLabel = document.getElementById('valueMinLabel');
    const valueMaxLabel = document.getElementById('valueMaxLabel');
    const valueDisplay = document.querySelector('.value-display');

    if (!valueMin || !valueMax || !valueMinLabel || !valueMaxLabel || !valueDisplay) return;

    function updateValueLabels() {
        const minValue = Number(valueMin.value).toLocaleString('nl-NL');
        const maxValue = Number(valueMax.value).toLocaleString('nl-NL');
        valueMinLabel.textContent = minValue;
        valueMaxLabel.textContent = maxValue;
        valueDisplay.textContent = '{% translate "Price" %}: €' + minValue + ' - €' + maxValue;
    }

    function updateForm() {
        const form = document.getElementById('filter-collapse');
        if (form) {
            form.submit();
        }
    }

    let timeout;
    valueMin.addEventListener('input', function() {
        if (parseInt(valueMin.value) > parseInt(valueMax.value)) {
            valueMin.value = valueMax.value;
        }
        updateValueLabels();
        clearTimeout(timeout);
        timeout = setTimeout(updateForm, 500);
    });

    valueMax.addEventListener('input', function() {
        if (parseInt(valueMax.value) < parseInt(valueMin.value)) {
            valueMax.value = valueMin.value;
        }
        updateValueLabels();
        clearTimeout(timeout);
        timeout = setTimeout(updateForm, 500);
    });

    // Keep dropdown open while interacting with sliders
    document.querySelectorAll('.dropdown').forEach(dropdown => {
        dropdown.addEventListener('click', function(e) {
            if (e.target.matches('input[type="range"]')) {
                e.stopPropagation();
            }
        });
    });

    // Initialize with current values
    updateValueLabels();
}

/**
 * Autocomplete functionality
 */
function initializeAutocomplete() {
    const searchInput = document.getElementById('search-input');
    const suggestionsDiv = document.getElementById('autocomplete-suggestions');

    if (!searchInput || !suggestionsDiv) return;

    let autocompleteTimeout;
    let selectedIndex = -1;
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getStatusBadgeClass(status) {
        const statusMap = {
            'available': 'bg-success',
            'issued_rent': 'bg-warning text-dark',
            'issued_loan': 'bg-warning text-dark',
            'issued_unprocessed': 'bg-warning text-dark',
            'maintenance_in_house': 'bg-info',
            'maintenance_external': 'bg-info',
            'under_review': 'bg-info',
            'placeholder': 'bg-light text-dark',
            'to_be_delivered': 'bg-secondary',
            'sold': 'bg-secondary',
            'amortized': 'bg-dark',
            'unknown': 'bg-danger'
        };
        return statusMap[status] || 'bg-primary';
    }

    function fetchSuggestions(query) {
        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        
        fetch('{% url 'inventory_frontend:autocomplete' %}?q=' + encodeURIComponent(query), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(suggestions => {
            if (suggestions && suggestions.length > 0) {
                showSuggestions(suggestions);
            } else {
                suggestionsDiv.style.display = 'none';
            }
                })
                .catch(error => {
                    console.error('Autocomplete error:', error);
                    suggestionsDiv.style.display = 'none';
                });
        }

        function showSuggestions(suggestions) {
            suggestionsDiv.innerHTML = '';
            selectedIndex = -1; // Reset selection
            suggestions.forEach((suggestion, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-bottom autocomplete-suggestion';
                div.style.cursor = 'pointer';
                div.dataset.index = index;
                
                // Create rich suggestion HTML
                let locationText = '';
                if (suggestion.location) {
                    locationText = suggestion.location;
                    if (suggestion.location_nr) {
                        locationText += ` #${suggestion.location_nr}`;
                    }
                }
                
                // Check customer mode
                const isCustomerMode = getCookie('customer_mode') === 'true';
                
                // Build HTML without template literals to avoid conflicts
                let html = '<div class="d-flex justify-content-between align-items-start">';
                html += '<div class="flex-grow-1">';
                html += '<div class="fw-bold text-dark">' + suggestion.name + '</div>';
                html += '<div class="small text-muted d-flex gap-2 flex-wrap">';
                
                if (suggestion.category) {
                    html += '<span class="badge bg-primary">' + suggestion.category + '</span>';
                }
                if (suggestion.size) {
                    html += '<span class="badge bg-secondary">' + suggestion.size + '</span>';
                }
                if (suggestion.current_status) {
                    const statusClass = getStatusBadgeClass(suggestion.current_status);
                    html += '<span class="badge ' + statusClass + '">' + suggestion.current_status_display + '</span>';
                }
                if (locationText) {
                    html += '<span class="text-muted">' + locationText + '</span>';
                }
                if (!isCustomerMode && suggestion.created_at) {
                    html += '<span class="text-muted">Created: ' + suggestion.created_at + '</span>';
                }
                
                html += '</div></div>';
                html += '<div class="text-end ms-2">';
                
                if (!isCustomerMode) {
                    html += '<div class="small text-muted purchase-price">Purchase: €' + suggestion.purchase_value.toFixed(0) + '</div>';
                }
                if (suggestion.is_disposed) {
                    html += '<div class="small text-warning">Disposed: ' + suggestion.disposal_reason + '</div>';
                }
                html += '<div class="fw-bold text-success">€' + suggestion.listing_price.toFixed(0) + '</div>';
                html += '</div></div>';
                
                div.innerHTML = html;
                
                div.addEventListener('click', function() {
                    suggestionsDiv.style.display = 'none';
                    window.location.href = '/new/' + suggestion.id + '/';
                });
                
                div.addEventListener('mouseenter', function() {
                    selectedIndex = parseInt(this.dataset.index);
                    updateSelection();
                });
                
                div.addEventListener('mouseleave', function() {
                    // Keep the selection if it's keyboard selected, otherwise clear
                    if (selectedIndex !== parseInt(this.dataset.index)) {
                        this.style.backgroundColor = '';
                    }
                });
                
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.style.display = 'block';
        }

        function updateSelection() {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            suggestions.forEach((suggestion, index) => {
                if (index === selectedIndex) {
                    suggestion.style.backgroundColor = '#e3f2fd';
                    suggestion.scrollIntoView({ block: 'nearest' });
                } else {
                    suggestion.style.backgroundColor = '';
                }
            });
        }

        function selectCurrentSuggestion() {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            if (selectedIndex >= 0 && selectedIndex < suggestions.length) {
                const selectedSuggestion = suggestions[selectedIndex];
                selectedSuggestion.click();
            }
        }

        // Set up input event listener
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            clearTimeout(autocompleteTimeout);
            
            if (query.length >= 2) {
                autocompleteTimeout = setTimeout(() => fetchSuggestions(query), 300);
            } else {
                suggestionsDiv.style.display = 'none';
            }
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                fetchSuggestions(this.value.trim());
            }
        });

        // Add keyboard navigation
        searchInput.addEventListener('keydown', function(e) {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            const isVisible = suggestionsDiv.style.display === 'block' && suggestions.length > 0;

            if (!isVisible) return;

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = selectedIndex < suggestions.length - 1 ? selectedIndex + 1 : 0;
                    updateSelection();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : suggestions.length - 1;
                    updateSelection();
                    break;
                case 'Enter':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectCurrentSuggestion();
                    }
                    break;
                case 'Escape':
                    suggestionsDiv.style.display = 'none';
                    selectedIndex = -1;
                    break;
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
}

/**
 * Clickable table rows functionality
 */
function initializeClickableRows() {
    const clickableRows = document.querySelectorAll('.clickable-row');
    
    clickableRows.forEach(row => {
        row.addEventListener('click', function() {
            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
        
        // Add hover effects
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
            this.style.transform = 'scale(1.01)';
            this.style.transition = 'all 0.2s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
            this.style.transform = '';
        });
    });
}

/**
 * Clickable card functionality for grid view
 */
function initializeClickableCards() {
    const clickableCards = document.querySelectorAll('.clickable-card');
    
    clickableCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // Don't navigate if clicking on a button or link
            if (e.target.closest('a, button')) {
                return;
            }

            const href = this.getAttribute('data-href');
            if (href) {
                window.location.href = href;
            }
        });
    });
}

/**
 * Location group functionality
 */
function initializeLocationGroups() {
    // Initialize location group states on page load
    document.querySelectorAll('.location-group-checkbox').forEach(groupCheckbox => {
        const groupId = groupCheckbox.getAttribute('data-group-id');
        updateLocationGroupState(groupId);
    });
}

/**
 * Location group state management
 */

function updateLocationGroupState(groupId) {
    const groupCheckbox = document.getElementById(`location-group-${groupId}`);
    const locationCheckboxes = document.querySelectorAll(`input[data-group-id="${groupId}"].location-checkbox`);
    
    if (!groupCheckbox || locationCheckboxes.length === 0) return;
    
    const checkedLocations = Array.from(locationCheckboxes).filter(cb => cb.checked);
    
    if (checkedLocations.length === 0) {
        // No locations checked - group unchecked
        groupCheckbox.checked = false;
        groupCheckbox.indeterminate = false;
    } else if (checkedLocations.length === locationCheckboxes.length) {
        // All locations checked - group checked
        groupCheckbox.checked = true;
        groupCheckbox.indeterminate = false;
    } else {
        // Some locations checked - group indeterminate
        groupCheckbox.checked = false;
        groupCheckbox.indeterminate = true;
    }
}
</script>
{% endblock %}
