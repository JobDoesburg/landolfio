{% extends "page.html" %}
{% load static i18n %}

{% block header %}
    <h2 class="text-center">Landolfio</h2>
    <p class="lead text-center">
        {% translate "Inventory management" %}
    </p>
{% endblock %}

{% block extrastyle %}
<style>
    #categories-accordion,
    #locations-accordion {
        position: relative;
    }

    .category-wrapper,
    .location-wrapper {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    .collapse-spacer {
        height: 0;
        overflow: hidden;
        transition: height 0.35s ease;
        flex-shrink: 0;
    }

    .collapse-content {
        position: absolute;
        width: 100vw;
        max-width: 100vw;
        z-index: 100;
        padding: 0 1rem;
        opacity: 0;
        transition: opacity 0.35s ease;
        box-sizing: border-box;
    }

    .collapse-content.show {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
    <form action="{% url 'inventory_frontend:list' %}" method="get">
        <div class="position-relative mb-4">
            <input type="text" name="q" id="search-input" class="form-control form-control-lg shadow-sm"
                   placeholder="{% blocktranslate with count=total_assets|default:'0' %}Search {{ count }} assets...{% endblocktranslate %}"
                   autocomplete="off">
            <div id="autocomplete-suggestions" class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 400px; overflow-y: auto;"></div>
            <button type="submit" class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2">
                <i class="fas fa-search text-muted"></i>
            </button>
        </div>

        <!-- New Asset Button -->
        <div class="d-flex justify-content-center gap-2 mb-3">
            <a href="{% url 'inventory_frontend:create' %}" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>{% translate "New Asset" %}
            </a>
            <a href="{% url 'inventory_frontend:bulk_update' %}" class="btn btn-primary">
                <i class="fas fa-layer-group me-2"></i>{% translate "Bulk Update" %}
            </a>
            <a href="{% url 'admin:index' %}" class="btn btn-outline-secondary" title="Settings">
                <i class="fas fa-cog me-2"></i>{% translate "Admin" %}
            </a>
        </div>

        <p class="text-muted text-center mb-3">{% translate "Or immediately go to..." %}</p>

        <!-- Categories -->
        <div class="mb-3">
            <div class="text-center mb-2">
                <small class="text-muted text-uppercase">
                    {% translate "Categories" %}
                </small>
            </div>
            <!-- Desktop layout (md and up) -->
            <div class="d-none d-md-flex flex-wrap gap-2 justify-content-center">
                {% for category in categories %}
                    <div class="btn-group" role="group">
                        <a href="{% url 'inventory_frontend:list' %}?category={{ category.id }}" class="btn btn-outline-primary">
                            {{ category.name }}
                        </a>
                        {% for size_data in category.sizes_with_counts %}
                            <a href="{% url 'inventory_frontend:list' %}?category={{ category.id }}&size={{ size_data.size.id }}" class="btn btn-outline-secondary">
                                {{ size_data.size.name }}
                            </a>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <!-- Mobile layout (small screens) -->
            <div class="d-md-none">
                <div id="categories-accordion" class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for category in categories %}
                        <div class="category-wrapper">
                            <div class="btn-group" role="group">
                                <a href="{% url 'inventory_frontend:list' %}?category={{ category.id }}" class="btn btn-sm btn-outline-primary">
                                    {{ category.name }}
                                </a>
                                {% if category.sizes_with_counts %}
                                    <button class="btn btn-sm btn-outline-primary px-2" type="button" data-bs-toggle="collapse" data-bs-target="#category-{{ category.id }}-sizes" aria-expanded="false">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                {% endif %}
                            </div>
                            {% if category.sizes_with_counts %}
                                <div class="collapse-spacer" data-spacer-for="category-{{ category.id }}-sizes"></div>
                                <div class="collapse-content" id="category-{{ category.id }}-sizes-content" style="display: none;">
                                    <div class="d-flex flex-wrap gap-1 mt-1 mb-3 justify-content-center">
                                        {% for size_data in category.sizes_with_counts %}
                                            <a href="{% url 'inventory_frontend:list' %}?category={{ category.id }}&size={{ size_data.size.id }}" class="btn btn-sm btn-outline-secondary">
                                                {{ size_data.size.name }}
                                            </a>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Locations -->
        <div class="mb-3">
            <div class="text-center mb-2">
                <small class="text-muted text-uppercase">
                    {% translate "Locations" %}
                </small>
            </div>
            <!-- Desktop layout (md and up) -->
            <div class="d-none d-md-flex flex-wrap gap-2 justify-content-center">
                {% for location in locations %}
                    <div class="btn-group" role="group">
                        <a href="{% url 'inventory_frontend:list' %}?location={{ location.id }}" class="btn btn-outline-primary">
                            {{ location.name }}
                        </a>
                        {% for child_data in location.children_with_counts %}
                            <a href="{% url 'inventory_frontend:list' %}?location={{ child_data.location.id }}" class="btn btn-outline-secondary">
                                {{ child_data.location.name }}
                            </a>
                            {% if child_data.location.grandchildren_with_counts %}
                                {% for grandchild_data in child_data.location.grandchildren_with_counts %}
                                    <a href="{% url 'inventory_frontend:list' %}?location={{ grandchild_data.location.id }}" class="btn btn-outline-secondary">
                                        {{ grandchild_data.location.name }}
                                    </a>
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <!-- Mobile layout (small screens) -->
            <div class="d-md-none">
                <div id="locations-accordion" class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for location in locations %}
                        <div class="location-wrapper">
                            <div class="btn-group" role="group">
                                <a href="{% url 'inventory_frontend:list' %}?location={{ location.id }}" class="btn btn-sm btn-outline-primary">
                                    {{ location.name }}
                                </a>
                                {% if location.children_with_counts %}
                                    <button class="btn btn-sm btn-outline-primary px-2" type="button" data-bs-toggle="collapse" data-bs-target="#location-{{ location.id }}-children" aria-expanded="false">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                {% endif %}
                            </div>
                            {% if location.children_with_counts %}
                                <div class="collapse-spacer" data-spacer-for="location-{{ location.id }}-children"></div>
                                <div class="collapse-content" id="location-{{ location.id }}-children-content" style="display: none;">
                                    <div class="d-flex flex-wrap gap-1 mt-1 mb-3 justify-content-center">
                                        {% for child_data in location.children_with_counts %}
                                            <a href="{% url 'inventory_frontend:list' %}?location={{ child_data.location.id }}" class="btn btn-sm btn-outline-secondary">
                                                {{ child_data.location.name }}
                                            </a>
                                            {% if child_data.location.grandchildren_with_counts %}
                                                {% for grandchild_data in child_data.location.grandchildren_with_counts %}
                                                    <a href="{% url 'inventory_frontend:list' %}?location={{ grandchild_data.location.id }}" class="btn btn-sm btn-outline-secondary">
                                                        {{ grandchild_data.location.name }}
                                                    </a>
                                                {% endfor %}
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Collections -->
        <div class="mb-3">
            <div class="text-center mb-2">
                <small class="text-muted text-uppercase">
                    {% translate "Collections" %}
                </small>
            </div>
            <!-- Desktop layout -->
            <div class="d-none d-md-flex flex-wrap gap-2 justify-content-center">
                {% for collection in collections %}
                    <a href="{% url 'inventory_frontend:list' %}?collection={{ collection.id }}" class="btn btn-outline-primary">
                        {{ collection.name }}
                    </a>
                {% endfor %}
            </div>
            <!-- Mobile layout -->
            <div class="d-md-none">
                <div class="d-flex flex-wrap gap-2 justify-content-center">
                    {% for collection in collections %}
                        <a href="{% url 'inventory_frontend:list' %}?collection={{ collection.id }}" class="btn btn-sm btn-outline-primary">
                            {{ collection.name }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </form>
{% endblock %}

{% block body_js %}
<script>
console.log('Index page: JavaScript is loading!');

document.addEventListener('DOMContentLoaded', function() {
    console.log('Index page: DOMContentLoaded fired');
    
    // Autocomplete functionality
    const searchInput = document.getElementById('search-input');
    const suggestionsDiv = document.getElementById('autocomplete-suggestions');
    
    console.log('Index page autocomplete elements:', {
        searchInput: !!searchInput,
        suggestionsDiv: !!suggestionsDiv
    });

    if (searchInput && suggestionsDiv) {
        let autocompleteTimeout;
        let selectedIndex = -1;
        
        // Cookie helper function for autocomplete
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getStatusBadgeClass(status) {
            const statusMap = {
                'available': 'bg-success',
                'issued_rent': 'bg-warning text-dark',
                'issued_loan': 'bg-warning text-dark',
                'issued_unprocessed': 'bg-warning text-dark',
                'maintenance_in_house': 'bg-info',
                'maintenance_external': 'bg-info',
                'under_review': 'bg-info',
                'placeholder': 'bg-light text-dark',
                'to_be_delivered': 'bg-secondary',
                'sold': 'bg-secondary',
                'amortized': 'bg-dark',
                'unknown': 'bg-danger'
            };
            return statusMap[status] || 'bg-primary';
        }

        function fetchSuggestions(query) {
            console.log('Index page: Fetching suggestions for:', query);
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

            fetch(`{% url 'inventory_frontend:autocomplete' %}?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    console.log('Index page: Autocomplete response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(suggestions => {
                    console.log('Index page: Autocomplete suggestions:', suggestions);
                    if (suggestions && suggestions.length > 0) {
                        showSuggestions(suggestions);
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Index page: Autocomplete error:', error);
                    suggestionsDiv.style.display = 'none';
                });
        }

        function showSuggestions(suggestions) {
            suggestionsDiv.innerHTML = '';
            selectedIndex = -1; // Reset selection
            suggestions.forEach((suggestion, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-bottom autocomplete-suggestion';
                div.style.cursor = 'pointer';
                div.dataset.index = index;
                
                // Create rich suggestion HTML
                let locationText = '';
                if (suggestion.location) {
                    locationText = suggestion.location;
                    if (suggestion.location_nr) {
                        locationText += ` #${suggestion.location_nr}`;
                    }
                }
                
                // Check customer mode
                const isCustomerMode = getCookie('customer_mode') === 'true';
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark">${suggestion.name}</div>
                            <div class="small text-muted d-flex gap-2 flex-wrap">
                                ${suggestion.category ? `<span class="badge bg-primary">${suggestion.category}</span>` : ''}
                                ${suggestion.size ? `<span class="badge bg-secondary">${suggestion.size}</span>` : ''}
                                ${suggestion.current_status ? `<span class="badge ${getStatusBadgeClass(suggestion.current_status)}">${suggestion.current_status_display}</span>` : ''}
                                ${locationText ? `<span class="text-muted">${locationText}</span>` : ''}
                                ${!isCustomerMode && suggestion.created_at ? `<span class="text-muted">Created: ${suggestion.created_at}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-end ms-2">
                            ${!isCustomerMode ? `<div class="small text-muted purchase-price">Purchase: €${suggestion.purchase_value.toFixed(0)}</div>` : ''}
                            ${suggestion.is_disposed ? `<div class="small text-warning">Disposed: ${suggestion.disposal_reason}</div>` : ''}
                            <div class="fw-bold text-success">€${suggestion.listing_price.toFixed(0)}</div>
                        </div>
                    </div>
                `;
                
                div.addEventListener('click', function() {
                    console.log('Index page: Suggestion clicked:', suggestion);
                    suggestionsDiv.style.display = 'none';
                    // Navigate directly to detail page
                    window.location.href = `/new/${suggestion.id}/`;
                });
                
                div.addEventListener('mouseenter', function() {
                    selectedIndex = parseInt(this.dataset.index);
                    updateSelection();
                });
                
                div.addEventListener('mouseleave', function() {
                    // Keep the selection if it's keyboard selected, otherwise clear
                    if (selectedIndex !== parseInt(this.dataset.index)) {
                        this.style.backgroundColor = '';
                    }
                });
                
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.style.display = 'block';
        }

        function updateSelection() {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            suggestions.forEach((suggestion, index) => {
                if (index === selectedIndex) {
                    suggestion.style.backgroundColor = '#e3f2fd';
                    suggestion.scrollIntoView({ block: 'nearest' });
                } else {
                    suggestion.style.backgroundColor = '';
                }
            });
        }

        function selectCurrentSuggestion() {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            if (selectedIndex >= 0 && selectedIndex < suggestions.length) {
                const selectedSuggestion = suggestions[selectedIndex];
                selectedSuggestion.click();
            }
        }

        searchInput.addEventListener('input', function() {
            console.log('Index page: Search input changed:', this.value);
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => {
                fetchSuggestions(this.value.trim());
            }, 300);
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                fetchSuggestions(this.value.trim());
            }
        });

        // Add keyboard navigation
        searchInput.addEventListener('keydown', function(e) {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            const isVisible = suggestionsDiv.style.display === 'block' && suggestions.length > 0;

            if (!isVisible) return;

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = selectedIndex < suggestions.length - 1 ? selectedIndex + 1 : 0;
                    updateSelection();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : suggestions.length - 1;
                    updateSelection();
                    break;
                case 'Enter':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectCurrentSuggestion();
                    }
                    break;
                case 'Escape':
                    suggestionsDiv.style.display = 'none';
                    selectedIndex = -1;
                    break;
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        console.log('Index page: Autocomplete setup complete');
    }

    // Rotate chevron icons on collapse toggle
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(button => {
        const targetId = button.getAttribute('data-bs-target');
        if (targetId) {
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.addEventListener('show.bs.collapse', function() {
                    const icon = button.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.style.transform = 'rotate(180deg)';
                        icon.style.transition = 'transform 0.3s ease';
                    }
                });
                targetElement.addEventListener('hide.bs.collapse', function() {
                    const icon = button.querySelector('.fa-chevron-down');
                    if (icon) {
                        icon.style.transform = 'rotate(0deg)';
                    }
                });
            }
        }
    });

    // Mobile collapse behavior: make parent buttons toggle collapse first
    document.querySelectorAll('.d-md-none .btn-group a.btn').forEach(link => {
        const btnGroup = link.closest('.btn-group');
        if (!btnGroup) return;

        const toggleButton = btnGroup.querySelector('[data-bs-toggle="collapse"]');
        if (!toggleButton) return;

        const targetId = toggleButton.getAttribute('data-bs-target');
        if (!targetId) return;

        const collapseElement = document.querySelector(targetId);
        if (!collapseElement) return;

        link.addEventListener('click', function(e) {
            // Check if collapse is currently hidden
            if (!collapseElement.classList.contains('show')) {
                e.preventDefault();
                // Show the collapse
                const bsCollapse = new bootstrap.Collapse(collapseElement, {
                    toggle: true
                });
                // Remove active state from button
                this.blur();
            }
            // If collapse is already shown, let the link navigate normally
        });
    });

    // Manual collapse handling
    let currentOpenCategory = null;
    let currentOpenLocation = null;

    // Handle categories
    const categoriesAccordion = document.getElementById('categories-accordion');
    if (categoriesAccordion) {
        const categoryWrappers = categoriesAccordion.querySelectorAll('.category-wrapper');

        categoryWrappers.forEach(wrapper => {
            const toggleBtn = wrapper.querySelector('[data-bs-toggle="collapse"]');
            if (!toggleBtn) return;

            const targetId = toggleBtn.getAttribute('data-bs-target');
            const spacer = wrapper.querySelector('.collapse-spacer');
            const collapseContent = wrapper.querySelector('.collapse-content');

            if (!spacer || !collapseContent) return;

            toggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Close currently open category if different
                if (currentOpenCategory && currentOpenCategory !== wrapper) {
                    const oldSpacer = currentOpenCategory.querySelector('.collapse-spacer');
                    const oldContent = currentOpenCategory.querySelector('.collapse-content');
                    const oldToggleBtn = currentOpenCategory.querySelector('[data-bs-toggle="collapse"]');
                    oldSpacer.style.height = '0';
                    oldContent.classList.remove('show');
                    if (oldToggleBtn) oldToggleBtn.classList.remove('active');
                    setTimeout(() => oldContent.style.display = 'none', 350);
                }

                // Toggle current
                const isOpen = spacer.style.height && spacer.style.height !== '0px';

                if (isOpen) {
                    // Close
                    spacer.style.height = '0';
                    collapseContent.classList.remove('show');
                    toggleBtn.classList.remove('active');
                    setTimeout(() => collapseContent.style.display = 'none', 350);
                    currentOpenCategory = null;
                } else {
                    // Open
                    const btnGroup = wrapper.querySelector('.btn-group');
                    const rect = btnGroup.getBoundingClientRect();
                    const wrapperRect = wrapper.getBoundingClientRect();

                    // Find all buttons on the same row
                    let maxBottom = rect.bottom;
                    categoryWrappers.forEach(w => {
                        const wBtn = w.querySelector('.btn-group');
                        const wRect = wBtn.getBoundingClientRect();
                        if (Math.abs(wRect.top - rect.top) < 5) {
                            maxBottom = Math.max(maxBottom, wRect.bottom);
                        }
                    });

                    const topPosition = maxBottom - wrapperRect.top + 8;
                    collapseContent.style.top = topPosition + 'px';

                    // Center on viewport
                    collapseContent.style.left = -wrapperRect.left + 'px';

                    collapseContent.style.display = 'block';

                    const contentHeight = collapseContent.offsetHeight;
                    spacer.style.height = contentHeight + 'px';

                    setTimeout(() => collapseContent.classList.add('show'), 10);
                    toggleBtn.classList.add('active');
                    currentOpenCategory = wrapper;
                }
            });
        });
    }

    // Handle locations
    const locationsAccordion = document.getElementById('locations-accordion');
    if (locationsAccordion) {
        const locationWrappers = locationsAccordion.querySelectorAll('.location-wrapper');

        locationWrappers.forEach(wrapper => {
            const toggleBtn = wrapper.querySelector('[data-bs-toggle="collapse"]');
            if (!toggleBtn) return;

            const targetId = toggleBtn.getAttribute('data-bs-target');
            const spacer = wrapper.querySelector('.collapse-spacer');
            const collapseContent = wrapper.querySelector('.collapse-content');

            if (!spacer || !collapseContent) return;

            toggleBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                // Close currently open location if different
                if (currentOpenLocation && currentOpenLocation !== wrapper) {
                    const oldSpacer = currentOpenLocation.querySelector('.collapse-spacer');
                    const oldContent = currentOpenLocation.querySelector('.collapse-content');
                    const oldToggleBtn = currentOpenLocation.querySelector('[data-bs-toggle="collapse"]');
                    oldSpacer.style.height = '0';
                    oldContent.classList.remove('show');
                    if (oldToggleBtn) oldToggleBtn.classList.remove('active');
                    setTimeout(() => oldContent.style.display = 'none', 350);
                }

                // Toggle current
                const isOpen = spacer.style.height && spacer.style.height !== '0px';

                if (isOpen) {
                    // Close
                    spacer.style.height = '0';
                    collapseContent.classList.remove('show');
                    toggleBtn.classList.remove('active');
                    setTimeout(() => collapseContent.style.display = 'none', 350);
                    currentOpenLocation = null;
                } else {
                    // Open
                    const btnGroup = wrapper.querySelector('.btn-group');
                    const rect = btnGroup.getBoundingClientRect();
                    const wrapperRect = wrapper.getBoundingClientRect();

                    // Find all buttons on the same row
                    let maxBottom = rect.bottom;
                    locationWrappers.forEach(w => {
                        const wBtn = w.querySelector('.btn-group');
                        const wRect = wBtn.getBoundingClientRect();
                        if (Math.abs(wRect.top - rect.top) < 5) {
                            maxBottom = Math.max(maxBottom, wRect.bottom);
                        }
                    });

                    const topPosition = maxBottom - wrapperRect.top + 8;
                    collapseContent.style.top = topPosition + 'px';

                    // Center on viewport
                    collapseContent.style.left = -wrapperRect.left + 'px';

                    collapseContent.style.display = 'block';

                    const contentHeight = collapseContent.offsetHeight;
                    spacer.style.height = contentHeight + 'px';

                    setTimeout(() => collapseContent.classList.add('show'), 10);
                    toggleBtn.classList.add('active');
                    currentOpenLocation = wrapper;
                }
            });
        });
    }
});
</script>
{% endblock %}