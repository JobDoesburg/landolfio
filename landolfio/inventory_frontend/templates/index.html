{% extends "page.html" %}
{% load static i18n %}

{% block header %}
    <h2 class="text-center">Landolfio</h2>
    <p class="lead text-center">
        {% translate "Inventory management" %}
    </p>
{% endblock %}

{% block content %}
    <form action="{% url 'inventory_frontend:list' %}" method="get">
        <div class="position-relative mb-4">
            <input type="text" name="q" id="search-input" class="form-control form-control-lg shadow-sm"
                   placeholder="{% blocktranslate with count=total_assets|default:'0' %}Search {{ count }} assets...{% endblocktranslate %}"
                   autocomplete="off">
            <div id="autocomplete-suggestions" class="position-absolute w-100 mt-1 bg-white border rounded shadow-lg" style="z-index: 1000; display: none; max-height: 400px; overflow-y: auto;"></div>
            <button type="submit" class="btn btn-link position-absolute top-50 end-0 translate-middle-y me-2">
                <i class="fas fa-search text-muted"></i>
            </button>
        </div>

        <!-- New Asset Button -->
        <div class="d-flex justify-content-center gap-2 mb-3">
            <a href="{% url 'inventory_frontend:create' %}" class="btn btn-success">
                <i class="fas fa-plus me-2"></i>{% translate "New Asset" %}
            </a>
            <a href="{% url 'inventory_frontend:bulk_update' %}" class="btn btn-primary">
                <i class="fas fa-layer-group me-2"></i>{% translate "Bulk Update" %}
            </a>
            <a href="{% url 'admin:index' %}" class="btn btn-outline-secondary" title="Settings">
                <i class="fas fa-cog me-2"></i>{% translate "Admin" %}
            </a>
        </div>

        <p class="text-muted text-center mb-3">{% translate "Or immediately go to..." %}</p>

        <!-- Categories -->
        <div class="mb-3">
            <div class="text-center mb-2">
                <small class="text-muted text-uppercase">
                    {% translate "Categories" %}
                </small>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-center">
                {% for category in categories %}
                    <div class="btn-group" role="group">
                        <a href="{% url 'inventory_frontend:list' %}?category={{ category.id }}" class="btn btn-outline-primary">
                            {{ category.name }}
                        </a>
                        {% for size_data in category.sizes_with_counts %}
                            <a href="{% url 'inventory_frontend:list' %}?category={{ category.id }}&size={{ size_data.size.id }}" class="btn btn-outline-secondary">
                                {{ size_data.size.name }}
                            </a>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Locations -->
        <div class="mb-3">
            <div class="text-center mb-2">
                <small class="text-muted text-uppercase">
                    {% translate "Locations" %}
                </small>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-center">
                {% for location in locations %}
                    <a href="{% url 'inventory_frontend:list' %}?location={{ location.id }}" class="btn btn-outline-primary">
                        {{ location.name }}
                    </a>
                {% endfor %}
            </div>
        </div>

        <!-- Collections -->
        <div class="mb-3">
            <div class="text-center mb-2">
                <small class="text-muted text-uppercase">
                    {% translate "Collections" %}
                </small>
            </div>
            <div class="d-flex flex-wrap gap-2 justify-content-center">
                {% for collection in collections %}
                    <a href="{% url 'inventory_frontend:list' %}?collection={{ collection.id }}" class="btn btn-outline-primary">
                        {{ collection.name }}
                    </a>
                {% endfor %}
            </div>
        </div>
    </form>
{% endblock %}

{% block body_js %}
<script>
console.log('Index page: JavaScript is loading!');

document.addEventListener('DOMContentLoaded', function() {
    console.log('Index page: DOMContentLoaded fired');
    
    // Autocomplete functionality
    const searchInput = document.getElementById('search-input');
    const suggestionsDiv = document.getElementById('autocomplete-suggestions');
    
    console.log('Index page autocomplete elements:', {
        searchInput: !!searchInput,
        suggestionsDiv: !!suggestionsDiv
    });

    if (searchInput && suggestionsDiv) {
        let autocompleteTimeout;
        let selectedIndex = -1;
        
        // Cookie helper function for autocomplete
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function getStatusBadgeClass(status) {
            const statusMap = {
                'available': 'bg-success',
                'issued_rent': 'bg-warning text-dark',
                'issued_loan': 'bg-warning text-dark',
                'issued_unprocessed': 'bg-warning text-dark',
                'maintenance_in_house': 'bg-info',
                'maintenance_external': 'bg-info',
                'under_review': 'bg-info',
                'placeholder': 'bg-light text-dark',
                'to_be_delivered': 'bg-secondary',
                'sold': 'bg-secondary',
                'amortized': 'bg-dark',
                'unknown': 'bg-danger'
            };
            return statusMap[status] || 'bg-primary';
        }

        function fetchSuggestions(query) {
            console.log('Index page: Fetching suggestions for:', query);
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

            fetch(`{% url 'inventory_frontend:autocomplete' %}?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    console.log('Index page: Autocomplete response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(suggestions => {
                    console.log('Index page: Autocomplete suggestions:', suggestions);
                    if (suggestions && suggestions.length > 0) {
                        showSuggestions(suggestions);
                    } else {
                        suggestionsDiv.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Index page: Autocomplete error:', error);
                    suggestionsDiv.style.display = 'none';
                });
        }

        function showSuggestions(suggestions) {
            suggestionsDiv.innerHTML = '';
            selectedIndex = -1; // Reset selection
            suggestions.forEach((suggestion, index) => {
                const div = document.createElement('div');
                div.className = 'p-3 border-bottom autocomplete-suggestion';
                div.style.cursor = 'pointer';
                div.dataset.index = index;
                
                // Create rich suggestion HTML
                let locationText = '';
                if (suggestion.location) {
                    locationText = suggestion.location;
                    if (suggestion.location_nr) {
                        locationText += ` #${suggestion.location_nr}`;
                    }
                }
                
                // Check customer mode
                const isCustomerMode = getCookie('customer_mode') === 'true';
                
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="fw-bold text-dark">${suggestion.name}</div>
                            <div class="small text-muted d-flex gap-2 flex-wrap">
                                ${suggestion.category ? `<span class="badge bg-primary">${suggestion.category}</span>` : ''}
                                ${suggestion.size ? `<span class="badge bg-secondary">${suggestion.size}</span>` : ''}
                                ${suggestion.current_status ? `<span class="badge ${getStatusBadgeClass(suggestion.current_status)}">${suggestion.current_status_display}</span>` : ''}
                                ${locationText ? `<span class="text-muted">${locationText}</span>` : ''}
                                ${!isCustomerMode && suggestion.created_at ? `<span class="text-muted">Created: ${suggestion.created_at}</span>` : ''}
                            </div>
                        </div>
                        <div class="text-end ms-2">
                            ${!isCustomerMode ? `<div class="small text-muted purchase-price">Purchase: €${suggestion.purchase_value.toFixed(0)}</div>` : ''}
                            ${suggestion.is_disposed ? `<div class="small text-warning">Disposed: ${suggestion.disposal_reason}</div>` : ''}
                            <div class="fw-bold text-success">€${suggestion.listing_price.toFixed(0)}</div>
                        </div>
                    </div>
                `;
                
                div.addEventListener('click', function() {
                    console.log('Index page: Suggestion clicked:', suggestion);
                    suggestionsDiv.style.display = 'none';
                    // Navigate directly to detail page
                    window.location.href = `/new/${suggestion.id}/`;
                });
                
                div.addEventListener('mouseenter', function() {
                    selectedIndex = parseInt(this.dataset.index);
                    updateSelection();
                });
                
                div.addEventListener('mouseleave', function() {
                    // Keep the selection if it's keyboard selected, otherwise clear
                    if (selectedIndex !== parseInt(this.dataset.index)) {
                        this.style.backgroundColor = '';
                    }
                });
                
                suggestionsDiv.appendChild(div);
            });
            suggestionsDiv.style.display = 'block';
        }

        function updateSelection() {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            suggestions.forEach((suggestion, index) => {
                if (index === selectedIndex) {
                    suggestion.style.backgroundColor = '#e3f2fd';
                    suggestion.scrollIntoView({ block: 'nearest' });
                } else {
                    suggestion.style.backgroundColor = '';
                }
            });
        }

        function selectCurrentSuggestion() {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            if (selectedIndex >= 0 && selectedIndex < suggestions.length) {
                const selectedSuggestion = suggestions[selectedIndex];
                selectedSuggestion.click();
            }
        }

        searchInput.addEventListener('input', function() {
            console.log('Index page: Search input changed:', this.value);
            clearTimeout(autocompleteTimeout);
            autocompleteTimeout = setTimeout(() => {
                fetchSuggestions(this.value.trim());
            }, 300);
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                fetchSuggestions(this.value.trim());
            }
        });

        // Add keyboard navigation
        searchInput.addEventListener('keydown', function(e) {
            const suggestions = suggestionsDiv.querySelectorAll('.autocomplete-suggestion');
            const isVisible = suggestionsDiv.style.display === 'block' && suggestions.length > 0;

            if (!isVisible) return;

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = selectedIndex < suggestions.length - 1 ? selectedIndex + 1 : 0;
                    updateSelection();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = selectedIndex > 0 ? selectedIndex - 1 : suggestions.length - 1;
                    updateSelection();
                    break;
                case 'Enter':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectCurrentSuggestion();
                    }
                    break;
                case 'Escape':
                    suggestionsDiv.style.display = 'none';
                    selectedIndex = -1;
                    break;
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });

        console.log('Index page: Autocomplete setup complete');
    }
});
</script>
{% endblock %}